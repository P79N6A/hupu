<?phpnamespace app\api\controller;use Think\Controller;use think\Db;class IntegralApi extends Controller {    const __OK__ = '0'; //请求成功    const __ERROR__ = '1'; //参数错误    const __ERROR1__ = '2'; //没有绑定    const __ERROR2__ = '3';//数据库错误    private  $code_expire_time = 160;//验证码过期时间    private  $array_return = array("ResultType"=>1,"Message"=>"success","AppendData"=>[]);    private  $_reqparam;    private  $userInfo;    public function initialize()    {        $this->_reqparam = $this->request->param();        if($this->_reqparam['spopenid']) {            $this->userInfo=D("Api/User",'Logic')->getUserInfoOption(array('spopenid'=>$this->_reqparam['spopenid']));        }elseif($this->_reqparam['unionid']) {            $this->userInfo = Db::table('s_user_info')->where(array('unionid'=>$this->_reqparam['unionid']))->find();        }elseif($this->_reqparam['id']){            $this->userInfo = Db::table('s_user_info')->find($this->_reqparam['id']);        }else{            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="非法访问";            $this->array_return['data']=null;            return json($this->array_return);        }        if(!$this->userInfo)        {            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="没有该用户或登录失败";            $this->array_return['data']=null;            return json($this->array_return);        }else{            $this->_reqparam['userInfo']=$this->userInfo;        }    }    /**     * 获取当前用户信息     */    public function get_info()    {        $uid = $this->userInfo['id'];        $res = Db::table("s_user_info")->where('id='.$uid)->find();        if ($res) {            $this->array_return['ResultType'] = self::__OK__;            $this->array_return['Message'] = "操作成功";            $this->array_return['AppendData'] = $res;        } else {            $this->array_return['ResultType'] = self::__ERROR2__;            $this->array_return['Message'] = "操作失败";        }        return json($this->array_return);    }    /**     * 判断是否签到     */    public function is_sign()    {        $uid = $this->userInfo['id'];        $res = Db::table('s_inte_log')->where('user_id='.$uid.' and inte_id=1 and addtime>'.strtotime(date("Ymd")))->limit(1)->select();        if ($res)         {            $this->array_return['ResultType'] = self::__OK__;            $this->array_return['Message'] = "今日已签到";            $this->array_return['AppendData'] = 1;        } else {            $this->array_return['ResultType'] = self::__OK__;            $this->array_return['Message'] = "去签到";            $this->array_return['AppendData'] = 0;        }        return json($this->array_return);    }       /**     * 获取积分列表     */    public function get_intlist()    {        $uid = $this->userInfo['id'];        $start = $this->_reqparam['start'];        $type = $this->_reqparam['type'];        if($start>=0 && $type >=0){            if($type==0){                $res = Db::table("s_inte_log")->alias('i')->where('i.type=0 and i.user_id='.$uid)->join(' LEFT JOIN s_inte l on i.inte_id=l.id')->field("i.type,i.id,l.title,i.addtime,i.inte")->order('i.id desc')->limit($start,15)->select();                }else{                $res = Db::table("s_inte_log")->alias('i')->where('i.type=1 and i.user_id='.$uid)->join(' LEFT JOIN s_inte l on i.inte_id=l.id')->field("i.type,i.id,l.title,i.addtime,i.inte")->order('i.id desc')->limit($start,15)->select();                }                         foreach($res as $k=>$v){                $res[$k]['addtime']=date("Y.m.d", $v['addtime']);             }            if ($res) {                $this->array_return['ResultType'] = self::__OK__;                $this->array_return['Message'] = "操作成功";                $this->array_return['AppendData'] = $res;            } else {                $this->array_return['ResultType'] = self::__ERROR2__;                $this->array_return['Message'] = "操作失败";            }        }else{            $this->array_return['ResultType'] = self::__ERROR__;            $this->array_return['Message'] = "缺少参数";        }        return json($this->array_return);     }      /**     *  获取基本信息完善度     */    public function get_infodegree(){        $uid = $this->userInfo['id'];        $res = Db::table("s_user_info")->where('id='.$uid)->field('headimg,wx_ewm_url,sq_type_id,company,share_my_introduct,position')->find();        $num=0;        if(preg_match('/(http:\/\/)|(https:\/\/)/i', $res['headimg'])){            $num=$num+1;        }        if($res['wx_ewm_url']!=''){            $num=$num+1;        }        if($res['sq_type_id']!=''){           $num=$num+1;         }        if($res['company']!=''){           $num=$num+1;         }        if($res['share_my_introduct']!=''){           $num=$num+1;         }        if($res['position']!=''){           $num=$num+1;         }        $num=round($num/6*100,2)."%";        if ($res) {            $this->array_return['ResultType'] = self::__OK__;            $this->array_return['Message'] = "操作成功";            $this->array_return['AppendData'] = $num;        } else {            $this->array_return['ResultType'] = self::__ERROR2__;            $this->array_return['Message'] = "操作失败";        }        return json($this->array_return);    }       /**     * 获取今日积分     */    public function get_todayinte()    {        $uid = $this->userInfo['id'];        $num1 =0;        $num = Db::table('s_inte_log')->where('user_id='.$uid.' and type=0 and addtime>'.strtotime(date("Ymd")))->suDb::table('s_inte');        if($num){            $num1 += $num;        }        $give_num = Db::table('s_give_inte_log')->where(array('object_id'=>$uid,'addtime'=>array('egt',strtotime(date("Ymd")))))->suDb::table('s_inte');        if($give_num){            $num1 += $give_num;        }        if ($num1) {            $this->array_return['ResultType'] = self::__OK__;            $this->array_return['Message'] = "操作成功";            $this->array_return['AppendData'] = $num1;        }else{            $this->array_return['ResultType'] = self::__ERROR2__;            $this->array_return['Message'] = "操作失败";            $this->array_return['AppendData'] = $num1;        }                return json($this->array_return);    }    /**     * 赠送积分好友列表     */    public function inte_user_list()    {        $name = $this->_reqparam['name'];//关键字        if(isset($name)){            $list = Db::table('s_user_info')->alias('u')                ->join('left join s_member m on m.id = u.member_id')                ->where(array('u.nick_name | m.phone'=>array('like',array('%'.$name.'%')),'u.vip_id'=>array('gt',0),'u.id'=>array('neq',$this->userInfo['id'])))                ->field('u.id,u.nick_name,u.headimg,m.phone')->limit(20)->select();            foreach ($list as $key=>$v){                if(substr($v['headimg'],0,4) != 'http'){                    $list[$key]['headimg'] = 'https://wap.yxm360.com'.$list[$key]['headimg'];                }            }            if ($list) {                $this->array_return['ResultType'] = self::__OK__;                $this->array_return['Message'] = "操作成功";                $this->array_return['AppendData'] = $list;            } else {                $this->array_return['ResultType'] = self::__ERROR2__;                $this->array_return['Message'] = "操作失败";            }        }else{            $this->array_return['ResultType'] = self::__ERROR__;            $this->array_return['Message'] = "缺少参数";        }        return json($this->array_return);    }    /**     * 赠送积分     */    public function give_inte()    {        $user_id = $this->_reqparam['user_id'];//对方用户id        $inte = $this->_reqparam['inte'];//赠送的积分数        $msg = $this->_reqparam['msg'];//备注信息        if(!$user_id || !$inte){            $this->array_return['ResultType'] = self::__ERROR__;            $this->array_return['Message'] = "缺少参数";            return json($this->array_return);        }        if($inte > $this->userInfo['inte']){            $this->array_return['ResultType'] = self::__ERROR1__;            $this->array_return['Message'] = "您没有足够的积分";            return json($this->array_return);        }        if(floor($inte/100) != $inte/100){            $this->array_return['ResultType'] = self::__ERROR1__;            $this->array_return['Message'] = "请填写100的倍数";            return json($this->array_return);        }        $this->array_return['ResultType'] = self::__ERROR2__;        $this->array_return['Message'] = "操作失败";          Db::startTrans();		try {            $r = Db::table('s_user_info')->where(array('id'=>$this->userInfo['id']))->setDec('inte',$inte);            $res = Db::table('s_user_info')->where(array('id'=>$user_id))->setInc('inte',$inte);            $log = Db::table('s_give_inte_log')->add(array('user_id'=>$this->userInfo['id'],'object_id'=>$user_id,'inte'=>$inte,'msg'=>$msg?$msg:'','addtime'=>time()));		    Db::commit();		    $this->array_return['ResultType'] = self::__OK__;        	$this->array_return['Message'] = "操作成功";		} catch (\Exception $e) {		    // 回滚事务		    Db::rollback();		}                    return json($this->array_return);    }    /**     * 赠送积分日志     */    public function give_inte_log()    {        $type = $this->_reqparam['type'];//1:我赠送的   2：我获取的        if($type == 2) {            if ($this->_reqparam['num']) {//获取未读的条数                $num = Db::table('s_give_inte_log')->where(array('object_id' => $this->userInfo['id'], 'is_read' => 0))->count();                if ($num) {                    $this->array_return['ResultType'] = self::__OK__;                    $this->array_return['Message'] = "操作成功";                    $this->array_return['AppendData'] = $num;                } else {                    $this->array_return['ResultType'] = self::__ERROR2__;                    $this->array_return['Message'] = "操作失败";                }            } else {//我获取的积分日志                $start = $this->_reqparam['start'] > 0 ? $this->_reqparam['start'] : 0;                $length = $this->_reqparam['length'] > 0 ? $this->_reqparam['length'] : 10;                $list = Db::table('s_give_inte_log')->alias('g')                    ->join('left join s_user_info u on u.id = g.user_id')                    ->where(array('g.object_id' => $this->userInfo['id']))                    ->field('u.nick_name,g.addtime,g.inte,g.msg,g.is_read')                    ->limit($start, $length)->order('g.is_read asc,g.id desc')->select();                if ($list) {                    foreach ($list as $k => $v) {                        $list[$k]['addtime'] = date('Y-m-d H:i', $v['addtime']);                    }                    //修改所有未读的状态为已读                    Db::table('s_give_inte_log')->where(array('object_id' => $this->userInfo['id'], 'is_read' => 0))->save(array('is_read' => 1));                    $this->array_return['ResultType'] = self::__OK__;                    $this->array_return['Message'] = "操作成功";                    $this->array_return['AppendData'] = $list;                } else {                    $this->array_return['ResultType'] = self::__ERROR2__;                    $this->array_return['Message'] = "操作失败";                }            }        }elseif($type == 1){            $start = $this->_reqparam['start'] > 0 ? $this->_reqparam['start'] : 0;            $length = $this->_reqparam['length'] > 0 ? $this->_reqparam['length'] : 10;            $list = Db::table('s_give_inte_log')->alias('g')                ->join('left join s_user_info u on u.id = g.object_id')                ->where(array('g.user_id' => $this->userInfo['id']))                ->field('u.nick_name,g.addtime,g.inte,g.msg,g.is_read')                ->limit($start, $length)                ->order('g.is_read asc,g.id desc')                ->select();            if ($list) {                foreach ($list as $k => $v) {                    $list[$k]['addtime'] = date('Y-m-d H:i', $v['addtime']);                }                $this->array_return['ResultType'] = self::__OK__;                $this->array_return['Message'] = "操作成功";                $this->array_return['AppendData'] = $list;            } else {                $this->array_return['ResultType'] = self::__ERROR2__;                $this->array_return['Message'] = "操作失败";            }        }else{            $this->array_return['ResultType'] = self::__ERROR__;            $this->array_return['Message'] = "缺少参数";        }        return json($this->array_return);    }}