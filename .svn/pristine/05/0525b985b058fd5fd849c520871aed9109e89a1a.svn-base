<?phpnamespace app\api\controller;use app\common\controller\ApiBase;use think\Db;class PayCodeApi extends ApiBase {        /**     * 体验卡记录列表     */    public function pay_code_list()     {        $status = $this->_reqparam['status'];        $start = $this->_reqparam['start'] ? $this->_reqparam['start'] : 0;        $length = $this->_reqparam['length'] ? $this->_reqparam['length'] : 10;        $where['p.type'] = 0;        $where['p.user_id'] = $this->userInfo['id'];        $lists['all_count'] = Db::table('s_pay_code')->alias('p')->where($where)->count();        if ($status == 0) { //未赠送            $where['p.status'] = 0;            $lists['data'] = Db::table('s_pay_code')->alias('p')->field('p.code')->where($where)->limit($start, $length)->select();            $lists['not_used_count'] = Db::table('s_pay_code')->alias('p')->where($where)->count();        } else { //已赠送            $where['p.status'] = $status;            $lists['data'] = Db::table('s_pay_code')->alias('p')->join('left join s_pay_code_log l on l.code_id = p.id')->join('left join s_user_detail u on u.id = l.user_id')->field('p.code,u.nick_name,u.headimg,p.addtime')->where($where)->limit($start, $length)->select();            foreach ($lists['data'] as $k => $v) {                //兼容头像没路径                if (substr($v['headimg'], 0, 4) != 'http') {                    $lists['data'][$k]['headimg'] = 'http://' . $_SERVER['HTTP_HOST'] . $v['headimg'];                }                $lists['data'][$k]['addtime'] = date('Y-m-d H:i:s', $v['addtime']);            }            $lists['used_count'] = Db::table('s_pay_code')->alias('p')->where($where)->count();        }                if ($lists) {            $this->array_return['ResultType'] = self::__OK__;            $this->array_return['Message'] = "操作成功";            $this->array_return['AppendData'] = $lists;        } else {            $this->array_return['ResultType'] = self::__ERROR2__;            $this->array_return['Message'] = "操作失败";        }                return json($this->array_return);    }}