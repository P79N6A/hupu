<?php/** 访问管理 */namespace app\home\controller;use app\common\controller\HomeBase;class Grant extends HomeBase{    /**     * 访客统计     */    public function index()    {       $this->id=$this->userInfo['unionid'];       $user_info = session("user_info");        if (!$user_info){            header("location:".url("Home/Mycenter/login"));            exit;        }        $user = Db::table('s_user_info')->where(array('id'=>$user_info['id']))->field('money')->find();        $member = Db::table('s_member')->where(array('id'=>$user_info['member_id']))->field('id,phone')->find();        $this->assign('grant_user_phone',$member['phone']);        $this->assign('grant_user_info_id',$user_info['id']);        $this->assign('money',$user['money']);    	return $this->fetch();    }        /**     * 判断是否存在此用户,转赠用     */    public function is_user_exist()    {        $phone = Input('post.phone');        $my_phone = Db::table('s_member')->where(array('id'=>$this->userInfo['member_id']))->getField('phone');        if($phone == $my_phone){            return json(array('status'=>0,'msg'=>'不能转赠给自己'));        }        $res = Db::table('s_member')->where(array('phone'=>$phone))->field("id")->find();        if($res){            return json(array('status'=>1,'msg'=>'此用户存在'));        }else{            return json(array('status'=>0,'msg'=>'此用户未注册'));        }    }    public function grantMoney()    {        $phone = Input('post.phone');        $money = Input('post.money');        $code = Input('post.code');        $grant_user_phone = Input('post.grant_user_phone');        $grant_user_info_id = Input('post.grant_user_info_id');        $type = Input('post.type');        $receiver_member = Db::table('s_member')->where(array('phone'=>$phone))->field("id")->find();        if(!$receiver_member){            return json(array('status'=>1,'msg'=>'此用户不存在'));        }        $receiver_user_info =  Db::table('s_user_info')->where(array('member_id'=>$receiver_member['id']))->field("id")->find();        $user_info = Db::table('s_user_info')->where(array('id'=>$grant_user_info_id))->field("id,money")->find();        if($money > $user_info['money']){            return json(array('status'=>2,'msg'=>'转赠金额不能大于余额'));        }        //判断验证码        $where['phone'] = $grant_user_phone;        $where['type'] = $type;        $where['code'] = $code;        $where['expire_time'] = array('gt',time());        $is = Db::table('s_mobile_code')->where($where)->order('id desc')->find();        if(!$is){            return json(array('status'=>3,'msg'=>'验证码错误或过期'));        }        $data['grant_user_id'] = $grant_user_info_id;        $data['receiver_user_id'] = $receiver_user_info['id'];        $data['money'] = $money;        $data['create_time'] = time();        $data['status'] = 1;                Db::startTrans();	    try {	        $grant_id = Db::table('s_grant')->insert($data);	        $grant_res =  Db::table('s_user_info')->where(array('id'=>$grant_user_info_id))->setDec('money',$money);	        $receiver_res =  Db::table('s_user_info')->where(array('id'=>$receiver_user_info['id']))->setInc('money',$money);	        Db::table('s_grant')->where(['id'=>$grant_id])->save(['status'=>2]);            Db::commit();            return json(array('status'=>4,'msg'=>'转赠成功'));        } catch (\Exception $e) {            Db::rollback();            return json(array('status'=>5,'msg'=>'转赠失败'));        }    }    }