<extend name="./base" />

<block name="css_extend">
	<style>
		* {
			padding: 0;
			margin: 0;
		}

		ul {
			list-style: none;
		}

		.cen {
			width: 100%;
			height: 150px;
			/*display: flex;*/
		}

		.cen>div {
			float: left;
		}

		.cover-img {
			width: 50%;
			height: 260px;
		}

		.cover-img>img {
			width: 100%;
			height: 100%;
		}

		.bgc {
			width: 50%;
			height: 200px;
		}

		p {
			width: 100%;
			height: 80px;
			line-height: 80px;
			text-align: center;
			font-size: 20px;
		}

		.within>ul {
			overflow: hidden;
			float: left;
		}

		.show-li {
			width: 30%;
			height: 215px;
			margin: 5px;
			float: left;
		}

		.show-li>a {
			display: block;
			width: 100%;
			height: 70%;
			position: relative;
		}

		.show-li>a>img {
			width: 100%;
			height: 100%;
		}

		.mui-icon {
			position: absolute;
			top: 0;
			right: 0;
			background: rgba(100, 100, 100, 0.5);
			color: red;
		}

		.end {
			width: 100%;
			height: 60px;
		}

		.btn {
			width: 100%;
			height: 40px;
			font-size: 0;
		}

		.pre {
			width: 50%;
			height: 85%;
			border: 0;
		}

		.edit {
			width: 50%;
			height: 85%;
			border: 0;
			background-color: #2FB3D3;
			color: #fff;
		}

		#file0 {
			display: none;
		}

		.add {
			background: rgba(150, 150, 150, 0.5);
			width: 30%;
			height: 215px;
			line-height: 195px;
			text-align: center;
			font-size: 40px;
			float: left;
			margin-bottom: 70px;
		}

		.inp {
			margin-top: -5px;
			width: 100%;
			height: 30px;
		}

		.inp>input {
			width: 100%;
			height: 30px;
			margin-bottom: 0;
		}

		.zzc_blue_bg {
			width: 100%;
		}

		.zzc_myranwen_bottom {
			margin-top: 100px;
		}

		#clipArea {
			/*margin-top: 100px;*/
			height: 85%;
		}

		#file0 {
			margin: 20px;
		}

		input {
			-webkit-appearance: none;
			border-radius: 0;
		}

		.clip {
			background-color: #000;
			display: none;
			width: 100%;
			height: 100%;
			position: fixed;
			top: 0;
			z-index: 10000;
		}

		.photo-clip-view {
			background-color: #fff;
		}

		.btun {
			width: 262px;
			height: 10%;
			margin: 0 auto;
		}

		#clipBtn {
			width: 35%;
			height: 40px;
			line-height: 40px;
			background-color: #2FB3D3;
			color: #fff;
			text-align: center;
			border: none;
			position: relative;
			z-index: 20;
		}

		#cancel {
			background-color: #fff;
			color: #000;
			width: 35%;
			height: 40px;
			line-height: 40px;
			border-radius: 5px;
			border: none;
			margin-right: 28%;
			position: relative;
			z-index: 20;
		}

		.gif {
			position: fixed;
			top: 0;
			left: 0;
			z-index: 1;
			width: 100%;
			height: 100%;
			text-align: center;
			display: none;
		}

		.gif>img {
			width: 20%;
			position: absolute;
			left: 40%;
			top: 36%;
		}

		.mask {
			width: 150px;
			height: 120px;
			background: rgba(0, 0, 0, 0.8);
			border-radius: 5px;
			position: fixed;
			top: 50%;
			left: 50%;
			margin-top: -60px;
			margin-left: -75px;
			display: none;
		}

		.mask img {
			width: 40px;
			height: 40px;
			display: block;
			margin: 0 auto;
			margin-top: 20px;
			margin-bottom: 20px;
			animation: rotate 3s linear infinite;
		}

		.mask p {
			color: #fff;
			text-align: center;
			line-height: 0;
			height: auto;
		}

 #share_title{
	 font-size: 14px;
 }
	</style>
</block>
<block name="body">

	<body class="">
		<div class="clip">
			<div class="gif">
				<img src="" alt="" />
			</div>
			<div id="clipArea"></div>
			<div class="btun">
				<button id="cancel" style="padding:0">取消</button>
				<button id="clipBtn" style="padding:0">截取</button>
			</div>
		</div>

		<div class="top">
			<div class="cen">
				<div class="cover-img">
					<img src="" id="img0">
					<input type="file" name="file0" id="file0" multiple="multiple" />
					<input type="hidden" name="headimg" id="cover_input" value="{$data.headimg}">
				</div>
				<div class="bgc">
					<a href="{:U('Home/Photo/music', array('pid'=>$id,'sid'=>$sid))}">
						<p>背景音乐</p>
					</a>
					<p>
						<input type="text" placeholder="*请输入您要分享的标题" id="share_title" value=" " />
					</p>
				</div>
			</div>
			<div>
				<textarea name="" rows="5" cols="55" placeholder="*请输入您要分享的内容" id="share_con" value=""></textarea>
			</div>
		</div>
		<div class="within">
			<!-- <span class="wh-span">
				<span class="show-li">
					<a href="{:U('Home/Photo/preview')}">
						<img src="__HOME_IMAGES__/tixiantongzhi.png" />
						<span class="mui-icon mui-icon-closeempty"></span>
			</a>
			<div class="btn">
				<a href="{:U('Home/Photo/preview')}">
					<button class="pre">预览</button>
				</a>
				<a href="{:U('Home/Photo/compile')}">
					<button class="edit">编辑</button>
				</a>
			</div>
			<div class="inp">
				<input type="text" value="1" />
			</div>
			</span>
			</span>-->
			<!-- {:U('Home/Photo/all')} -->
			<span class="show-li add">
				<a href="javascript:void(0)" onclick="myadd()">+</a>
			</span>
		</div>
		<input type="hidden" id="mids" value="" />
		<div class="end"></div>
		<input type="hidden" id="type_id" value="{$type_id}" />
		<input type="hidden" id="music_id" value="{$music_id}" />
		<div class="zzc_myranwen_bottom">
			<input type="button" name="" id="save" value="确定" class="zzc_myruanwen_bottom_button zzc_blue_bg" onclick="sub()" />
		</div>
		<div class="mask">
			<img src="/Public/Home/images/loadad.gif" alt="">
			<p>图片上传中</p>
		</div>
		<script src="__HOME_JS__/ljcut/jquery-2.1.3.min.js"></script>
		<script src="__HOME_JS__/ljcut/iscroll-zoom.js"></script>
		<script src="__HOME_JS__/ljcut/hammer.js"></script>
		<script src="__HOME_JS__/ljcut/lrz.all.bundle.js"></script>
		<script src="__HOME_JS__/ljcut/jquery.photoClip.js"></script>

		<script>
			$(".mui-icon").click(function () {
				$(".show-li").css("display", "none")
			})

			function myadd() {
				var sid = '{$sid}';
				var mids = $("#mids").val();
				window.location.href = "__ROOT__/index.php?s=/Home/Photo/all/sid/" + sid + "/mids/" + mids;
			}
		</script>
		<script>
			function sub() {
				var id = '{$id}';
				var sid = '{$sid}';
				var img = $("#img0").attr("src");

				var share_title = $("#share_title").val();
				var share_content = $("#share_con").val();
				var music_id = $("#music_id").val();
				var cids = '{$cids}';
				// alert(cids);
				$.ajax({
					//几个参数需要注意一下
					type: "POST", //方法类型
					dataType: "json", //预期服务器返回的数据类型
					url: "index.php?s=/Api/IndexApi/edit_album_content", //url 
					data: {
						"id": id,
						"my_id": sid,
						"cover_img": img,
						"share_title": share_title,
						"share_content": share_content,
						"music_id": music_id
					},
					success: function (result) {
						if (result.ResultType == 0) {
							mui.toast("修改成功");
							window.location.href = "index.php?s=/Home/Photo/index/cids/" + cids;
						}
						if(result.ResultType == 3){
							mui.toast("修改成功");
							window.location.href = "index.php?s=/Home/Photo/index/cids/" + cids;
						}


					},
					error: function () {
						alert("服务器繁忙，请稍后再试！");
					}
				})


			}

			function del(a) {
				var id = '{$id}';
				var user_content_id = a;

				// alert(a);
				mui.confirm("是否删除？", "", ["否", "是"], function (res) {
					if (res.index == 1) {
						$.ajax({
							//几个参数需要注意一下
							type: "POST", //方法类型
							dataType: "json", //预期服务器返回的数据类型
							url: "index.php?s=/Api/IndexApi/del_user_album_detail", //url 
							data: {
								"id": id,
								"user_content_id": user_content_id
							},
							success: function (result) {
								if (result.ResultType == 0) {
									// var img=$("#kk").data('id');
									// console.log(img);
									// $.ajax({
									// //几个参数需要注意一下
									//    type: "POST",//方法类型
									//    dataType: "json",//预期服务器返回的数据类型
									//    url: "index.php?s=/Api/Qiniu/delUpload" ,//url
									//    data: {"id":id,"img":img,"bucket":"album"},
									//    async : false,
									//    success: function (result) {
									mui.toast("删除成功");

									setTimeout(function () {
										top.location.href = "";
									}, 1000);
									//    },
									//    error : function() {
									//        alert("服务器繁忙，请稍后再试！");
									//    }
									// });
									// alert(b);
									// console.log(result);
									//         	mui.toast("删除成功");

									// setTimeout(function() {
									// top.location.href = "";
									// }, 1000);
									// mui.alert("恭喜您删除成功！");
									// window.location.reload();return false;
								}
							},
							error: function () {
								alert("服务器繁忙，请稍后再试！");
							}
						});

					}

				});

			}
			$(function () {
				var id = '{$id}';
				var sid = '{$sid}';
				var cids = '{$cids}';

				console.log(id)
				console.log(sid)
				console.log(cids)

				$.ajax({
					//几个参数需要注意一下
					type: "POST", //方法类型
					dataType: "json", //预期服务器返回的数据类型
					url: "index.php?s=/Api/IndexApi/get_album_list", //url 
					data: {
						"id": id,
						"my_id": sid
					},
					async: false,
					success: function (result) {
						console.log(result)
						if (result.ResultType == 0) {
							// alert(result.AppendData.cover_img);
							$("#mids").val(result.AppendData.album_id);
							$("#img0").attr("src", result.AppendData.cover_img);
							$("#share_title").val(result.AppendData.share_title);
							$("#share_con").val(result.AppendData.share_content);
							var htmlstr = '';
							$.each(result.AppendData.content_detail, function (idx, item) {
								// alert(item.id); result.AppendData.id Home/Photo/compile
								// console.log(result.AppendData.content_detail);
								// htmlstr+='';
								htmlstr += '    <span class="wh-span">';
								htmlstr += '        <span class="show-li">';
								htmlstr += '            <a href="__ROOT__/index.php?s=/Home/Photo/preview/pids/' + item.id +
									'/mid/1/id/' + sid + '" >';
								htmlstr += '                <img src="' + item.img + '" data-id="' + item.img + '" id="kk"/>';
								htmlstr += '                <span class="mui-icon mui-icon-closeempty" onclick="del(' + item.id +
									');return false;">';
								htmlstr += '                </span>';
								htmlstr += '            </a>';
								htmlstr += '            <div class="btn">';
								htmlstr += '                <a href="__ROOT__/index.php?s=/Home/Photo/preview/pids/' + item.id +
									'/mid/1/id/' + sid + '">';
								htmlstr += '                    <button class="pre">预览</button>';
								htmlstr += '                </a>';
								htmlstr += '                <a href="__ROOT__/index.php?s=/Home/Photo/compile/tid/' + result.AppendData.id +
									'/pid/' + item.id + '/cids/' + cids + '">';
								htmlstr += '                    <button class="edit">编辑</button>';
								htmlstr += '                </a>';
								htmlstr += '            </div>';
								htmlstr += '            <div class="inp">';
								htmlstr += '                <input type="hidden" value="' + item.id + '" data-id="' + item.id +
									'" id="kk"/>';
								htmlstr += '                <input type="text" value="' + item.sort + '" data-id="' + item.sort +
									'" class="caname" name="caname"/>';

								htmlstr += '            </div>';
								htmlstr += '        </span>';
								htmlstr += '    </span>';
								// htmlstr+='</div>';
							});
							$(".within").before(htmlstr);

							// $(".caname").focus(function(){
							// 	alert($(this).val());
							// })



						}
					},
					error: function () {
						alert("服务器繁忙，请稍后再试！");
					}
				});

				$(".caname").blur(function () {
					if ($(this).val() != $(this).data('id')) {
						var idd = $(this).prev("#kk").val();
						var id = '{$id}';
						var valss = $(this).val();
						$.ajax({
							//几个参数需要注意一下
							type: "POST", //方法类型
							dataType: "json", //预期服务器返回的数据类型
							url: "index.php?s=/Api/IndexApi/edit_album_template", //url 
							data: {
								"id": id,
								"content_id": idd,
								"sort": valss
							},
							// async:false,
							success: function (result) {
								if (result.ResultType == 0) {}
							},
							error: function () {
								alert("服务器繁忙，请稍后再试！");
							}
						})
					}

				})

			})


			$('#img0').click(function () {
				$('#file0').click();
				$(".clip").show();
			});
			var clipArea = new bjj.PhotoClip("#clipArea", {
				size: [274, 277],
				outputSize: [640, 640],
				file: "#file0",
				view: "#view",
				ok: "#clipBtn",
				loadStart: function () {
					// console.log("照片读取中");
					$('.gif').show();
				},
				loadComplete: function () {
					// console.log("照片读取完成");
					$('.gif').hide();
				},
				clipFinish: function (dataURL) {
					var imgsize = document.getElementById('file0').files[0].size;
					if (imgsize > 1024 * 1024 * 3) {
						mui.toast("请上传小于3M的图片");
						return false;
					} else {
						var id = '{$id}';
						var imgsrc = dataURL
						$.ajax({
							//几个参数需要注意一下
							type: "POST", //方法类型
							dataType: "json", //预期服务器返回的数据类型
							url: "index.php?s=/Api/IndexApi/uploads_img", //url
							data: {
								"id": id,
								"img": imgsrc,
								"start_name": "photo"
							},
							beforeSend: function () {
								$(".mask").show();
							},
							success: function (result) {
								$(".mask").hide();
								if (result.ResultType == 0) {
									$("#img0").attr('src', result.AppendData);
								}
							},
							error: function () {
								$(".mask").hide();
								alert("服务器繁忙，请稍后再试！");
							}
						})

					}
				}
			});
			$("#cancel,#clipBtn").click(function () {
				$(".clip").hide();
			})
		</script>
		<script src="https://res.wx.qq.com/open/js/jweixin-1.0.0.js" type="text/javascript"></script>
		<script type="text/javascript">
			document.addEventListener('WeixinJSBridgeReady', function onBridgeReady() {
				// 通过下面这个API隐藏右上角按钮hideOptionMenu
				WeixinJSBridge.call('hideOptionMenu');
			});
		</script>
	</body>
</block>