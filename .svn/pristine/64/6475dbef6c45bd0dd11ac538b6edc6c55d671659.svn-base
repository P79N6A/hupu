<?php/***********文章逻辑层************ */namespace app\api\logic;use think\Model;use app\api\model\ArticleList  as artModel;use app\api\model\ArticleType  as typeModel;use app\api\model\Advert  as adverModel;use app\api\model\UserInfo  as userModel;use app\api\model\VideoCourses  as videoModel;use app\api\model\CapitalLog  as capitalModel;class ArticleList extends Model{    private $Article=null;    private $ArticleType=null;    private $Advert=null;    private $User=null;    private $VideoCoures=null;    private $CapitalLog=null;    private $pageNum=10;    function __construct()    {        $this->Article = new artModel();        $this->ArticleType = new typeModel();        $this->Advert = new adverModel();//文章广告        $this->User = new userModel();        $this->VideoCoures = new videoModel();		$this->CapitalLog = new capitalModel();    }    public function getArticle($options=array())    {        //获取文章中心列表        $where=array();        if(isset($options['is_home'])){            $where['is_home']=$options['is_home'];        }        if(!empty($options['user_id'])){            $where['user_id']=$options['user_id'];        }        if(isset($options['title'])){            $where['title']=$options['title'];        }        if(isset($options['atype_id'])){            $where['atype_id']=$options['atype_id'];        }        $where['is_video'] = array('neq',1);        $count = $this->Article->where($where)->count();        if(!empty($options['page'])){            if(empty($options['pageNum'])){                $options['pageNum']=$this->pageNum;            }            $options['limit']=($options['page']-1)*$options['pageNum'].",".$options['pageNum'];        }        $list = $this->Article->where($where)->order('id DESC')->limit($options['limit'])->select();        return array($list, $options['page'], $count);    }    public function getType($options=array())    {        //获取文章中心分类        if(isset($options['user_id'])){            $where['user_id']=$options['user_id'];        }                $list = $this->ArticleType->where($where)->select();        return $list;    }    public function captArticle($url="",$user_id)    {        //文章抓取        header("Content-Type: text/html;charset=utf-8");        $toutiao=preg_match('/toutiao/', $url);        if($toutiao){            $tit=titleArticle($url);            // return $tit;            $content = $tit['content'];            $data['thumb']=$tit['thumb'];            $data['title']=$tit['title'];            $data['content']=$content;            $data['user_id']=$user_id;            $data['atype_id']=0;            $data['add_time']=time();            $data['source_url']=$url;//抓取文章才有            $data['source_title']=$tit['title'];//抓取文章才有            if($data['title'] && $content){                $id=$this->addArticle($data);                return $id;            }else{                return false;            }        }        preg_match('/^http\:\/\/wx.yxm360.com/', $url, $matches);        preg_match('/^http\:\/\/yangxiaomi.vip/', $url, $ymarr);        if($matches[0]=='http://wx.yxm360.com' || $ymarr[0]=='http://yangxiaomi.vip'){             //正则表达式匹配文章id 			 $pattern = '/id\/([0-9]+)/i'; 			 preg_match($pattern,$url,$test);              $id = $test[1];             $this->Article->create($data);             $list=$this->Article->where('id='.$id)->select();             $data=array();             foreach($list as $key=>$lis){                $content = $lis['content'];                $data['thumb']=$lis['thumb'];                $data['title']=$lis['title'];                $data['content']=$content;                $data['user_id']=$user_id;                $data['atype_id']=0;                $data['add_time']=time();                $data['source_url']=$url;                $data['source_title']=$lis['title'];             }             if($data['title'] && $content){                $id=$this->addArticle($data);                return $id;            }else{                return false;            }        }        //https://mp.weixin.qq.com/s/_MojTHnzHsZ0uSRJDtoBCA         preg_match('/^https\:\/\/mp.weixin.qq.com/', $url, $matches);        if($matches[0]=='https://mp.weixin.qq.com')        {            $capt=captArticle($url);            $capt['content']=str_replace("�","",$capt['content']);              $content = $capt['content'];            $data['thumb']=$capt['thumb'];            $data['title']=$capt['title'];            $data['content']=$content;            $data['user_id']=$user_id;            $data['atype_id']=0;            $data['add_time']=time();            $data['source_url']=$url;//抓取文章才有            $data['source_title']=$capt['title'];//抓取文章才有            if($data['title'] && $content){                $id=$this->addArticle($data);                return $id;            }else{                return false;            }        }    }      public function delUserType($options=array())    {        //删除用户文章分类        $where['user_id']=$options['user_id'];        $where['id']=$options['id'];        $id=$this->ArticleType->where($where)->delete();        return $id;    }    public function addArticle($options=array())    {        //新建文章        $data=array();        $options['thumb'] = str_replace('/http://wx.yxm360.com//Uploads','http://wx.yxm360.com/Uploads',$options['thumb']);        $data['thumb']=$options['thumb'];        $data['user_id']=$options['user_id'];        $data['title']=$options['title'];        $data['content']=$options['content'];        $data['atype_id']=$options['atype_id'];        $data['code']=strRand(8);        $data['source_url']=$options['source_url'];//抓取文章才有        $data['source_title']=$options['source_title'];//抓取文章才有        $data['add_time']=time();        $this->Article->create($data);		        $id=$this->Article->insert();        return $id;    }    public function delArticle($options=array())    {        //删除文章        $where['user_id']=$options['user_id'];        $where['id']=$options['id'];        $id=$this->Article->where($where)->delete();        return $id;    }    public function addAdvert($options=array())    {        //新增广告        $data=array();        $data['user_id']=$options['user_id'];        $data['title']=$options['title'];//广告标题        $data['thumb']=$options['thumb'];        $data['content']=$options['content'];        $data['jump_url']=$options['jump_url'];        $data['is_article']=$options['is_article'];        $data['add_time']=time();        $id=$this->Advert->insert($data);        return $id;    }    public function getAdvertList($options=array())    {        //读取广告列表        $where=array();        if(isset($options['is_article'])) {            $where['is_article']=$options['is_article'];        }        $where['user_id'] = $options['user_id'];        $order="add_time desc";        $list=$this->Advert->where($where)->order($order)->select();        return $list;    }    public function editAdvert($options=array())    {        //编辑广告        $data=array();        $where['user_id']=$where['user_id'];        $data['title']=$options['title'];//广告标题        $data['thumb']=$options['thumb'];        $data['content']=$options['content'];        $data['jump_url']=$options['jump_url'];        $id = $this->Advert->where($where)->save($data);                return $id;    }    public function delAdvert($options=array())    {        //删除广告        $where['user_id']=$options['user_id'];        $where['id']=$options['id'];        $id = $this->Advert->where($where)->delete();                return $id;    }    public function setArticle($options=array())    {        //设置文章属性        switch ($options['type']) {            case 1:                //文章底部广告是否显示                $data['article_advert']=$options['value'];                break;            case 2:                //微V网广告                $data['article_cards']=$options['value'];                break;            case 3:                //文章打赏                $data['article_reward']=$options['value'];                break;            default:                $data['article_advert']=$options['value'];                break;        }        $where['user_id'] = $options['user_id'];        $id = $this->User->where($where)->save($data);                return $id;    }    public function editPromotion($options=array())    {        //微V网编辑        $data=array();        $where['user_id']=$options['user_id'];        if(isset($options['share_my_introduct'])){            //我的简介            $data['share_my_introduct']=$options['share_my_introduct'];        }        if(isset($options['share_my_advantage'])){            //我拥有的资源和优势            $data['share_my_advantage']=$options['share_my_advantage'];        }        if(isset($options['share_my_resource'])){            //我需要对接的资源            $data['share_my_resource']=$options['share_my_resource'];        }        if(isset($options['wx_ewm_url'])){            //二维码链接            $data['wx_ewm_url']=$options['wx_ewm_url'];        }        $id = $this->User->where($where)->save($data);                return $id;    }    public function getPromotion($options=array())    {        //微V网读取        $where['id']=$options['user_id'];        $field=array(            "share_my_introduct",            "share_my_advantage",            "share_my_resource",            "wx_ewm_url",            "nick_name",            "mobile",            "company",            "email",            "position",            "headimg",            "id"            );        $data = $this->User->field($field)->where($where)->find();                return $data;    }    public function getArticleInfo($options=array())    {        //获取文章详情        if(isset($options['user_id'])){            $where['user_id']=$options['user_id'];        }        $where['id']=$options['id'];//文章id        $this->Article->where($where)->setInc('visit',1);//浏览人数+1        $data=$this->Article->where($where)->find();        if(isset($options['m_user_id'])){            $where['user_id']=$options['m_user_id'];        }               $data['Advert'] = $this->getAdvertList(array('user_id'=>$where['user_id']));//广告列表       $data['promotion']=$this->getPromotion(array('user_id'=>$data['user_id']));//微V网              return $data;    }    public function payCallback($options=array())    {        //打赏回调        if($options['result_code']!="SUCCESS"){            return 0;        }        if(!isset($options['attach'])){            return 0;        }    	$order_id = $options['order_id'];        $user_id = Db::table('s_article_rewardlog')->where(array('id'=>$order_id))->getField('user_id');    	if(!$user_id){            return 0;        }        //打赏记录表id        $object_id = $order_id;        $type = $options['data']['type'];//2文章打赏 4视频打赏        if($type==4){            $data['msg']="视频打赏";        }else{            $data['msg']="文章打赏";        }        $log = $this->CapitalLog->where(array('order_sn'=>$options['out_trade_no'],'pay_sn'=>$options['transaction_id'],'user_id'=>$user_id))->find();		if ($log) {     		return 1;        }        $total_fee = $options['total_fee'] ;        $data['pay_sn']=$options['transaction_id'];//微信订单号        $data['order_sn']=$options['out_trade_no'];//商户订单号        $data['user_id']=$user_id;        $data['object_id']=$object_id;        $data['as'] = 1;//增加        $data['money'] = $total_fee;        $data['type']=$type;        $data['pay_callback']=json_encode($options);//第三方支付回调		$data['add_time'] = time();		        $this->CapitalLog->insert($data);        $this->User->where(array('id'=>$user_id))->setInc('money',$total_fee);        Db::table('s_article_rewardlog')->where(array('id'=>$order_id))->save(array('status'=>1));                echo "SUCCESS";    }    public function getVideoList($options=array())    {        //视频教程列表        $data=$this->VideoCoures->order("add_time desc")->select();        return $data;    }    public function getArticleVideo($options=array())    {        //视频教程        $where['is_video']=1;//文章id        $this->Article->where($where)->setInc('visit',1);//浏览人数+1        $data=$this->Article->where($where)->find();        $data['video']=$this->getVideoList();        $data['promotion']=$this->getPromotion(array('user_id'=>7));//微V网        return $data;    }}