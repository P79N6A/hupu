<extend name="./base" />
<block name="title">
	<title>小秘币转赠</title>
</block>
<block name="body">
	<style>
		body,
		html {
			background: #f4f4f4;
		}

		.clearfix::after {
			content: ".";
			clear: both;
			display: block;
			overflow: hidden;
			font-size: 0;
			height: 0;
		}

		.fl {
			float: left;
		}

		.fr {
			float: right;
		}

		.ren_logo_input {
			position: relative;
			width: 100%;
			height: 54px;
			line-height: 54px;
			color: #666;
			background: #fff;
			margin-top: 15px;
			overflow: hidden;

		}

		#account input {
			height: 100% !important;
			width: 70% !important;
			border: 0;
			font-size: 14px;
		}

		.span-style {
			height: 100% !important;
			width: 30% !important;
		}

		.span-style .text-style {
			text-indent: 17px;
			font-size: 15px;
		}

		.account_money {
			width: 100%;
			height: 54px;
			line-height: 54px;
			background: #fff;
			margin-top: 36px;
		}

		.account_money input {
			width: 70%;
			height: 100%;
			border: 0;
			font-size: 14px;
		}


		.grant_money_text {
			width: 30%;
			height: 100%;
			color: #666;
			text-indent: 17px;
			font-size: 15px;
		}



		.grant_money {
			width: 35%;
			height: 100%;

		}

		.ren_rg_input {
			width: 100%;
			background: #fff;
			height: 54px;
			line-height: 54px;
		}

		.ren_rg_input input {
			width: 70%;
			border: 0;
			height: 100%;
			line-height: 54px;
			font-size: 14px;
		}

		.money {
			width: 100%;
			height: 100%;
			color: #2FB3D3;
			font-size: 15px;
			height: 36px !important;
			text-align: right;
			padding-right: 21px;
			padding-top: 5px;
		}


		.get-code a {
			font-size: 15px;
			color: white;
			line-height: 37px;
			padding: 10px;
			height: 37px;
			margin-left: 10px;
			border-radius: 5px;
			background-color: #1E90FF;
		}




		.ren_login_submit {
			width: 316px;
			height: 50px;
			text-align: center;
			font-size: 16px;
			color: #fff;
			line-height: 50px;
			border-radius: 30px;
			background: #2FB3D3;
			box-shadow: 0px 5px 6px #3bb7cf61;
			position: fixed;
			bottom: 99px;
			left: 50%;
			margin-left: -158px;
		}

		#getcode {
			display: block;
			height: 100%;
			width: 30%;
			text-align: center;
			color: #fff;
			background: #2FB3D3;
		}

		input {
			margin-bottom: 0 !important;
		}

		#code {
			font-size: 14px;
		}

		.show_msg {
			width: 100%;
			height: 60px;
			margin-top: 15px;
			background: #fff;
			display: none;
		}

		.user_img_box {
			width: 20%;
			height: 100%;
			position: relative;
		}

		.run_name {
			width: 20%;
			height: 100%;
		}

		.run_name p {
			width: 75px;
			height: 100%;
			line-height: 60px;
			overflow: hidden;
			text-overflow: ellipsis;
			white-space: nowrap;
		}

		.user_img_box img {
			width: 45px;
			height: 45px;
			position: absolute;
			top: 50%;
			left: 50%;
			margin-left: -22.5px;
			margin-top: -22.5px;
			border-radius: 50%;
		}

		.run_phone {
			width: 60%;
			height: 100%;
			position: relative;
		}

		.run_phone p {
			width: 100%;
			height: 60px;
			line-height: 60px;
			font-size: 13px;
			text-indent: 10px;
		}

		.run_phone img {
			position: absolute;
			top: 50%;
			right: 10px;
			width: 26px;
			height: 26px;
			border-radius: 50%;
			margin-top: -13px;
		}

		#inputphone {
			z-index: 1;
			position: relative;
		}

		.confirm {
			position: absolute;
			width: 50px;
			height: 30px;
			top: 50%;
			margin-top: -15px;
			right: 10px;
			background: #2FB3D3;
			color: #fff;
			border: 0;
			cursor: pointer;
			z-index: 999;
			text-align: center;
		}
	</style>


	<body>
		<div class=" ren_logo_brg">
			<div class="ren_logo_div">

				<div class="zzc_all">


					<div class="ren_logo_input" id="account">
						<div class="span-style fl">
							<div class="text-style">对方账户：</div>
						</div>
						<input type="text" name="phone" id="inputphone" class="ren_logo_editpad_input fl" value="" placeholder="请输入注册手机号" />
						<button class="confirm">确定</button>
					</div>
					<div class="show_msg clearfix">

					</div>

					<div class="account_money clearfix">
						<div class="grant_money_text fl">转赠金额：</div>
						<input class="fl" type="text" name="money" value="" placeholder="转赠金额" />
					</div>
					<div class="money">剩余小秘币:{$money}</div>
					<div class="ren_rg_input clearfix">
						<input class="fl" type="text" name="code" value="" placeholder="请输入验证码" />
						<a class="fl" href="javascript:;" id="getcode">
							<span class="rss" id="code">获取验证码</span>
						</a>
					</div>


				</div>


				<div class="ren_login_submit" id="admin_login_submit">确认转赠</div>
			</div>
		</div>
	</body>
	<script>
		var user_id = '{$id}';
		var flag = true;
		$(".ren_logo_input").on("click", ".confirm", function (e) {
			e.stopPropagation();
			if ($(this).prev().val() == '') {
				return false;
			}
			if (!flag) {
				return false
			} else {
				flag = false;
				console.log("执行了1次")
				var textphone = $(this).prev().val();
				console.log(textphone)
				$.ajax({
					type: "post",
					url: "index.php?s=/Api/AppApi/res_user",
					data: {
						unionid: user_id,
						phone: textphone
					},
					success: function (res) {
						console.log(res)
							flag = false;
						if (res.ResultType != 0) {
							flag = true;
							console.log("走了")
							alert("请输入正确的注册手机号码");
						} else {
							$("#account").hide();
							var list = '';
							list += '<div class="user_img_box fl">'
							list += '<img src="' + res.AppendData.headimg + '" alt="">'
							list += '</div>'
							list += '<div class="fl run_name">'
							list += '<p class="use_name">' + res.AppendData.nick_name + '</p>'
							list += '</div>'
							list += '<div class="fl run_phone">'
							list += '<p class="use_phone">' + res.AppendData.phone + '</p>'
							list += '<img class="del" src="__HOME_IMAGES__/inco_bianji_de@2x.png" alt="">'
							list += '</div>'
							$(".show_msg").html(list)
							$(".show_msg").show();
						}

						console.log(flag)

					},
					error: function () {
						flag = false;
						alert("服务器繁忙,请稍后再试");
						location.reload();
					}
				})

			}

		})

		$(".show_msg").on("click", ".del", function () {
			$(".show_msg").hide();
			$("#account").show();

		})

		var h = $(window).height();
		$(window).resize(function () {
			if ($(window).height() < h) {
				$('#admin_login_submit').hide();
			}
			if ($(window).height() >= h) {
				$('#admin_login_submit').show();
			}
		});
	</script>
	<script>
		$(function () {
			var balance = '{$money}';
			var new_balance = balance - 0;

			$("#getcode").on("click", function () {

				var phone = $("input[name=phone]").val();
				var money = $("input[name=money]").val();
				var newmoney = money - 0;
				if (phone.length == 0) {
					mui.toast("请输入手机号");
					return;
				}

				if (money.length == 0) {
					mui.toast("请输入转赠金额");
					return;
				}

				if (newmoney > new_balance) {
					mui.toast("转赠金额不能大于余额");
					return;
				}


				if (newmoney % 100 != 0) {
					mui.toast("转赠金额必须是100的整数倍");
					return;
				}



				$.post("{:url('Home/Grant/is_user_exist')}", {
					"phone": phone
				}, function (res) {


					if (res.status == 0) {
						mui.toast(res.msg);
						return;

					} else {

						var code = document.getElementById('code');


						if (code.innerHTML != '获取验证码') {

							return;
						}

						var time = 59;
						var h;
						var flag;
						if (flag) {
							return false;
						}


						flag = true;

						h = setInterval(function () {
							if (time < 10) {
								time = '0' + time;
							}
							code.innerHTML = time + '秒后重新获取';

							document.getElementById("getcode").style.backgroundColor = "#E0EEEE";
							time--;
							if (time < 0) {
								clearInterval(h);
								flag = false;
								code.innerHTML = '获取验证码';
								document.getElementById("getcode").style.backgroundColor = "#2FB3D3";
							}
						}, 1000);


						var grant_user = '{$grant_user_phone}';

						var type = 6;

						$.post("{:url('Home/User/sendCodeForGrant')}", {

							"phone": grant_user,
							"type": type

						}, function (res) {

							console.log(res);

							if (res.status == 1) {
								mui.toast("发送成功");
							} else {
								mui.toast(res.msg);
							}



						});


					}
				});
			});


			$("#admin_login_submit").on("click", function () {
				var phone = $("input[name=phone]").val();
				var money = $("input[name=money]").val();
				var newmoney = money - 0;
				console.log(newmoney)
				console.log(new_balance)
				var code = $("input[name=code]").val();
				var grant_user_phone = '{$grant_user_phone}';
				var grant_user_info_id = '{$grant_user_info_id}';
				var type = 6;


				if (phone.length == 0) {
					mui.toast("请输入手机号");
					return;
				}

				if (money.length == 0) {
					mui.toast("请输入转赠金额");
					return;
				}

				if (newmoney > new_balance) {
					mui.toast("转赠金额不能大于余额");
					return;
				}


				if (money % 100 != 0) {
					mui.toast("转赠金额必须是100的整数倍");
					return;
				}

				if (code.length == 0) {
					mui.toast("请输入验证码");
					return;
				}


				$.post("{:url('Home/Grant/grantMoney')}", {

					"phone": phone,
					"money": money,
					"code": code,
					"grant_user_phone": grant_user_phone,
					"grant_user_info_id": grant_user_info_id,
					"type": type

				}, function (res) {

					if (res.status == 1) {
						mui.toast("此用户不存在");
					}

					if (res.status == 2) {
						mui.toast("转赠金额不能大于余额");
					}

					if (res.status == 3) {
						mui.toast("验证码错误或已过期");
					}
					if (res.status == 4) {
						mui.toast("转赠成功");

						setTimeout(function () {

							top.location.href = "{:url('Home/Capital/myWallet')}";
						}, 1000);
					}

					if (res.status == 5) {
						mui.toast("转赠失败");
					}

				});

				console.log("click");

			});

		});
	</script>



</block>
<block name="js_extend">


	<script src="https://res.wx.qq.com/open/js/jweixin-1.0.0.js" type="text/javascript"></script>


	<script type="text/javascript">
		document.addEventListener('WeixinJSBridgeReady', function onBridgeReady() {
			// 通过下面这个API隐藏右上角按钮hideOptionMenu
			WeixinJSBridge.call('hideOptionMenu');
		});
	</script>


</block>