<?php/** * Created by PhpStorm. * User: admin * Date: 2017/12/7 * Time: 0:16 */namespace app\api\controller;use app\common\controller\ApiBase;use think\Db;use app\api\model\UserInfo  as userModel;use app\api\model\Member  as memberModel;use app\api\logic\User  as userLogic;use app\api\logic\Member as memberLogic;use app\api\logic\Cards  as cardsrLogic;use app\api\logic\VipList  as vipLogic;class User extends  ApiBase{	private $user_mod = null;	private $member_mod = null;	private $user_logic = null;	private $cards_logic = null;	private $member_logic = null;	private $vip_logic = null;	    public function initialize()    {        parent::initialize();        require_once EXTEND_PATH.'/Weixin/class.wx_sdk_handler.php';//引入微信Api        require_once EXTEND_PATH.'/Weixin/class.wx_network.php'; //引入微信配置文件        require_once EXTEND_PATH.'/Weixin/class.wx_open_api.php';        require_once EXTEND_PATH.'/Weixin/interface.wx_database.php';        // 初始化SDK        $opt = array(            'app_id' => XCX_APP_ID,            'app_secret' => XCX_APP_SECRET,            'rsa_private_key' => XCX_RSA_PRIVATE_KEY,            'salt' => XCX_SALT,            'database' => $this->db,            'delegate' => $this        );        $this->user_logic = new userLogic();        $this->cards_logic = new cardsrLogic();        $this->member_logic = new memberLogic();        $this->vip_logic = new vipLogic();                $this->user_mod = new userModel();        $this->member_mod = new memberModel();                $this->sdk = new \WXSDKHandler($opt);        $actionName = strtolower($this->request->action());        $noLogin=array('loginbind','getopenid','getcode','updatewxheader','getusershare','getareas','registnobuy','share','getmy','bindgetcode','getviplist');        if(!in_array($actionName,$noLogin))        {            if($this->_reqparam['spopenid']) {                $this->userInfo=$this->user_logic->getUserInfoOption(array('spopenid'=>$this->_reqparam['spopenid']));            }else if($this->_reqparam['unionid']){                $this->userInfo =  $this->user_mod->where(array('unionid'=>$this->_reqparam['unionid']))->find();            }else{                $this->array_return['ResultType']=self::__ERROR__;                $this->array_return['Message']="非法访问";                $this->array_return['data']=null;                return json($this->array_return);            }            if(!$this->userInfo)            {                $this->array_return['ResultType']=self::__ERROR__;                $this->array_return['Message']="没有该用户或登录失败";                $this->array_return['data']=null;                return json($this->array_return);            }else{                $this->_reqparam['userInfo']=$this->userInfo;                $level=$this->user_logic->getVipLevl($this->userInfo['member_id']);                if($level['vip_group_id']<=0 && !in_array($actionName,array('newviporder','logout')))                {                    $this->array_return['ResultType']=self::__ERROR2__;//ERROR2，没有充值                    $this->array_return['Message']="您的账号尚未开通创客服务!";                    return json($this->array_return);                }            }        }    }    /**     * 控制小程序     */    public function xcx_show()    {        $array = array('luck'=>false,'pay_card'=>false);        $this->array_return['AppendData']=$array;        $this->array_return['ResultType']=self::__OK__;        $this->array_return['Message']="显示";        return json($this->array_return);    }    /**     * 获取用户的OPENID     *     */    public function GetOpenId()    {        $result= $this->sdk->GetOpenId();        return json($result);    }    // 个人信息接口    public function GetMy()    {        $res=$this->request;        //接口切换用unionid调数据        if($res['unionid']){            $res['wx_id'] = $this->userInfo =  $this->user_mod->where(array('unionid'=>$this->_reqparam['unionid']))->getField('id');        }        if(!is_numeric($res['res_id'])){            $res['res_id'] = $this->userInfo =  $this->user_mod->where(array('unionid'=>$res['res_id']))->getField('id');        }        if(!$res['name'] && !$res['wx_id'])        {            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="参数错误";        }else{            // 判断是否本人调数据            if($res['name']= = $res['spopenid'] || $res['wx_id'] == $res['res_id'])            {                $res['isMy']=true;            }            $data=$this->user_logic->xcxlogin($res);            if($data){                $this->array_return['AppendData']=$data;                $this->array_return['ResultType']=self::__OK__;                $this->array_return['Message']="获取成功";            }else{                $this->array_return['ResultType']=self::__ERROR1__;                $this->array_return['Message']="用户不存在或未绑定";            }        }                return json($this->array_return);    }    public function LoginBind()    {        $res=$this->request;        //判断参数        if(!$res['mobile'])        {            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="没有手机号";            return json($this->array_return);        }else{            $res['phone'] = $res['mobile'];        }        if(!$res['openid'])        {            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="没有用户微信授权";            return json($this->array_return);        }        if(!$res['password'])        {            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="没有密码";            return json($this->array_return);        }        $member=$this->member_logic->isExist(array('phone'=>$res['phone']));        if(!$member)        {            $this->array_return['ResultType']=self::__ERROR1__;//ERROR1，需要注册用户            $this->array_return['Message']="没有找到用户！";            return json($this->array_return);        }        $member=$this->member_logic->isExist(array('phone'=>$res['mobile'],'password'=>md5($res['password'])));        if(!$member)        {            $this->array_return['ResultType']=self::__ERROR2__;//ERROR2，没有充值            $this->array_return['Message']="密码错误！";            return json($this->array_return);        }        $res1=$this->user_logic->updateXcxOpenid(array('id'=>$member['id'],'openid'=>$res['openid']));        if($res1)        {            $this->array_return['ResultType']=self::__OK__;//ERROR2，没有充值            $this->array_return['Message']="绑定成功！";            return json($this->array_return);        }        $this->array_return['ResultType']=self::__ERROR2__;//ERROR2，没有充值        $this->array_return['Message']="更新数据时失败！";                return json($this->array_return);    }    public  function GetCode()    {        $res=$this->request;        if(!$res['mobile'])        {            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="没有手机号";            return json($this->array_return);        }else{            $res['phone'] = $res['mobile'];            $res['type']=1;        }        $data=$this->member_logic->SendUserPinCode($res);        if($data['status']==1)        {           $this->array_return['AppendData']=$data;           $this->array_return['ResultType']=self::__OK__;           $this->array_return['Message']="获取成功";        }else{           $this->array_return['AppendData']=$data;           $this->array_return['ResultType']=self::__ERROR__;           $this->array_return['Message']=$data['msg'];        }        return json($this->array_return);    }    public  function BindGetCode()    {        $res=$this->request;        if(!$res['mobile'])        {            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="没有手机号";            return json($this->array_return);        }else {            $isexist=$this->member_logic->isExist(array('phone'=>$res['mobile']));            if($isexist)            {                $res['phone'] = $res['mobile'];                $res['type']=1;            }else{                $this->array_return['ResultType']=self::__ERROR__;                $this->array_return['Message']="非注册用户不能获取验证码";                return json($this->array_return);            }        }        $data=$this->member_logic->SendUserPinCode($res);        if($data['status']==1)        {            $this->array_return['AppendData']=$data;            $this->array_return['ResultType']=self::__OK__;            $this->array_return['Message']="获取成功";        } else {            $this->array_return['AppendData']=$data;            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']=$data['msg'];        }                return json($this->array_return);    }    public function UpdateWxHeader() //登录    {        $this->array_return['ResultType']=self::__OK__;        $this->array_return['Message']="";        $this->array_return['AppendData']=null;        return json($this->array_return);    }    public function GetUserShare()    {        $openid=trim(input('name'));        $recreate=$this->_reqparam['recreate'];        if(!$openid)        {            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="没有用户微信授权";            return json($this->array_return);        }        if (!$recreate) { $recreate=0; }        $res = $this->user_logic->GetOrCreateShareImg($openid,$recreate);        if($res)        {            $this->array_return['AppendData']=$res;            $this->array_return['ResultType']=self::__OK__;            $this->array_return['Message']="获取成功";            return json($this->array_return);        }else{            $this->array_return['AppendData']=null;            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="产生未知错误";            return json($this->array_return);        }    }    public function GetMenu()    {        //判断参数        if(!$this->_reqparam['id'])        {            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="参数错误";            return json($this->array_return);        }        $res = $this->user_logic->getUsersNav($this->userInfo['id'],$this->_reqparam['id']);        if(!$res)        {            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="菜单为空";            $this->array_return['AppendData']=null;        }else{            $this->array_return['ResultType']=self::__OK__;            $this->array_return['Message']="获取菜单成功";            $this->array_return['AppendData']=$res;        }        return json($this->array_return);    }    public function EditMenu()    {        //判断参数        $this->_reqparam['user_id']=$this->userInfo['id'];        if(!$this->_reqparam['name']||$this->_reqparam['name']==''||is_null($this->_reqparam['name']))        {            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="导航名称和文本不能为空！";            return json($this->array_return);        }        $res = $this->user_logic->addUsersNav($this->request);        if(!$res)        {            $this->array_return['ResultType']=self::__ERROR__;            if($this->_reqparam['id'])            {                $this->array_return['Message']="更新菜单失败！";            }else{                $this->array_return['Message']="添加菜单失败！";            }            $this->array_return['AppendData']=null;        }else{            $this->array_return['ResultType']=self::__OK__;            if($this->_reqparam['id'])            {                $this->array_return['Message']="更新菜单成功！";            }else{                $this->array_return['Message']="添加菜单成功！";            }            $this->array_return['AppendData']=$res;        }        return json($this->array_return);    }    public  function GetAreas()    {        $res = $this->user_logic->GetAreas($this->request);        if(!$res)        {            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="获取城市失败！";            $this->array_return['AppendData']=null;        }else{            $this->array_return['ResultType']=self::__OK__;            $this->array_return['Message']="获取城市成功！";            $this->array_return['AppendData']=$res;        }        return json($this->array_return);    }    //TODO:此方法为小程序和APP共用接口，还需要开发公众号前端要调用的接口    public function EditContentXcx()    {        //判断参数        $this->_reqparam['user_id']=$this->userInfo['id'];        $res = $this->user_logic->addUsersContentXcx($this->request);        if(!$res)        {            $this->array_return['ResultType']=self::__ERROR__;            if($this->_reqparam['id'])            {                $this->array_return['Message']="更新内容失败！";            }else{                $this->array_return['Message']="添加内容失败！";            }            $this->array_return['AppendData']=null;        }else{            $this->array_return['ResultType']=self::__OK__;            if($this->_reqparam['id'])            {                $this->array_return['Message']="更新内容成功！";            }else{                $this->array_return['Message']="添加内容成功！";            }            $this->array_return['AppendData']=$res;        }        return json($this->array_return);    }    public function GetContentXcx()    {        //判断参数        if(!$this->_reqparam['id'])        {            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="参数错误";            return json($this->array_return);        }        $res = $this->user_logic->getUsersContentXcx($this->userInfo['id'],$this->_reqparam['id']);        if(!$res)        {            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="没有找到该内容";            $this->array_return['AppendData']=null;        }else{            $this->array_return['ResultType']=self::__OK__;            $this->array_return['Message']="获取内容成功";            $this->array_return['AppendData']=$res;        }        return json($this->array_return);    }    /**     * 更新我的V网     */    public function UpdateMycard()    {        $this->_reqparam['userInfo']=$this->userInfo;        $res = $this->user_logic->SaveMyCard($this->request);        if(!$res)        {            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="保存微网失败";            $this->array_return['AppendData']=null;        }else{            $this->array_return['ResultType']=self::__OK__;            $this->array_return['Message']="保存微网成功";            $this->array_return['AppendData']=$res;        }        return json($this->array_return);    }    /**     * 通过手机号和验证码注册：注册时的第一步，通过手机号和验证码注册完成，但是尚未购买变成vip用户地址     */    public function RegistNoBuy()    {        //判断是否有spopenid        if(!$this->_reqparam['spopenid'])        {            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="缺少重要参数";            return json($this->array_return);        }        //判断是否有推荐人spopenid        if(!$this->_reqparam['user_no'] && !$this->_reqparam['user_id'])        {            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="没有推荐人标识";            return json($this->array_return);        }else{            //获取推荐人Uid            if($this->_reqparam['user_no']){                $recordUser=$this->user_logic->getUserInfoOption(array('spopenid'=>$this->_reqparam['user_no']));            }else{                $recordUser =  $this->user_mod->find($this->_reqparam['user_id']);            }            //判断推荐人UID            if(!$recordUser){                $this->array_return['ResultType']=self::__ERROR__;                $this->array_return['Message']="没有该推荐人！";                return json($this->array_return);            }else{                $this->_reqparam['recordUser']=$recordUser;            }        }        //判断是否有手机号        if(empty($this->_reqparam['mobile'])||!preg_match("/^1[34578]{1}\d{9}$/",$this->_reqparam['mobile'])){            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="手机号码格式错误！";            return json($this->array_return);        }else{            //判断验证码            if(!$this->_reqparam['code'])            {                $this->array_return['ResultType']=self::__ERROR__;                $this->array_return['Message']="没有验证码";                return json($this->array_return);            }else{                $checked=$this->member_logic->CheckUserPinCode(array('phone'=>$this->_reqparam['mobile'],'type'=>1,'code'=>$this->_reqparam['code']));                if(!$checked){                    $this->array_return['ResultType']=self::__ERROR__;                    $this->array_return['Message']="验证码错误！";                    return json($this->array_return);                }            }        }                $res = $this->user_logic->xcx_register($this->request);        switch ($res['status'])////0、成功  1，己存在,2：没有传openid，没有授权,3、添加meber失败,4、添加用户失败 其它数值 是新增加的userid,5：没有推荐人            {        	case 0:        		$this->array_return['ResultType']=self::__OK__;          		$this->array_return['Message']="注册成功";        		$this->array_return['AppendData'] = $res['id'];        		break;        	case 1:         		$this->array_return['ResultType']=self::__ERROR__;         		$this->array_return['Message']="己存在该用户";        		$this->array_return['AppendData']=null;        		break;         	case 2:        		$this->array_return['ResultType']=self::__ERROR__;        		$this->array_return['Message']="没有授权小程序";         		$this->array_return['AppendData']=null;           		break;            	case 3:            		$this->array_return['ResultType']=self::__ERROR__;        		$this->array_return['Message']="添加会员信息失败";        		$this->array_return['AppendData']=null;          		break;          	case 4:            		$this->array_return['ResultType']=self::__ERROR__;            		$this->array_return['Message']="添加用户信息失败";           		$this->array_return['AppendData']=null;           		break;        	case 5:        		$this->array_return['ResultType']=self::__ERROR__;        		$this->array_return['Message']="获取推荐人信息失败";        		$this->array_return['AppendData']=null;        		break;        }        return json($this->array_return);    }    /**     * 获取用于小程序显示VIP列表和推荐人信息的购买页面     */    public  function  getVipList()    {        $viplist= $this->vip_logic->getVipList();        $newUser=$this->user_logic->getUserInfoOption(array('spopenid'=>$this->_reqparam['spopenid']));        if(empty($newUser))        {            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="必须通过推荐人注册";            $this->array_return['AppendData']=null;            return json($this->array_return);        }        $recordUser=$this->user_logic->getUserInfoOption(array('id'=>$newUser['rec_user_id']));        if(empty($recordUser))        {            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="推荐人错误，请联系技术人员重新注册!";            $this->array_return['AppendData']=null;            return json($this->array_return);        }        if($viplist&&$recordUser)        {            $result['viplist']=$viplist;            $result['recordUser']=$recordUser;            $this->array_return['ResultType']=self::__OK__;            $this->array_return['Message']="获取服务列表成功";            $this->array_return['AppendData']=$result;        }else{            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="获取服务列表失败";            $this->array_return['AppendData']=null;        }        return json($this->array_return);    }    /**     * 生成新的订单和支付信息     */    public  function  newVipOrder()    {        $this->_reqparam['user']=$this->userInfo;        if(!$this->_reqparam['vip_id'])        {            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="没有选择合适的产品";            return json($this->array_return);        }else {            $vip=Db::table('s_vip_list')->where(array("id"=>$this->_reqparam['vip_id']))->find();            if(!empty($vip))            {                $this->_reqparam['vip']=$vip;            }else {                $this->array_return['ResultType']=self::__ERROR__;                $this->array_return['Message']="没有选择合适的产品";                return json($this->array_return);            }        }                    $this->_reqparam['pay_source']='小程序';        $payinfo=$this->user_logic->XcxBuyVip($this->request);        if($payinfo)        {            $this->array_return['ResultType']=self::__OK__;            $this->array_return['Message']="生成支付信息成功";            $this->array_return['AppendData']=$payinfo['obj']['pra'];        }else{            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="生成支付信息失败";            $this->array_return['AppendData']=null;        }                return json($this->array_return);    }    /**     * 小程序年费接口     */    public  function  yearOrder()    {        $this->_reqparam['user']=$this->userInfo;        $payinfo=$this->user_logic->XcxBuyYear($this->request);        if($payinfo)        {            $this->array_return['ResultType']=self::__OK__;            $this->array_return['Message']="生成支付信息成功";            $this->array_return['AppendData']=$payinfo['obj']['pra'];        }else{            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="生成支付信息失败";            $this->array_return['AppendData']=null;        }                return json($this->array_return);    }    public function ChangePassword()    {        $id   = $this->userInfo['id'];        //TODO::完全用Logic来调用        $memberId =  $this->user_mod->where(array('id'=>$id))->getField("member_id");        $password =  $this->member_mod->where(array('id'=>$memberId))->getField('password');        $oldpwd   = md5($this->_reqparam['oldpwd']);        if($password != $oldpwd){            $this->array_return['ResultType']=$this::__ERROR__;            $this->array_return['Message']="原密码有误";        }else{            if($this->_reqparam['password1']!=$this->_reqparam['password2'] || empty($this->_reqparam['password1']) || empty($this->_reqparam['password2'])){                $this->array_return['ResultType']=$this::__ERROR__;                $this->array_return['Message']="新密码不一致或为空";            }else{                $res =  $this->member_mod->where(array('id'=>$memberId))->save(array('password'=>md5($this->_reqparam['password2'])));//更新                if($res){                    $this->array_return['ResultType']=$this::__OK__;                    $this->array_return['Message']="修改成功";                }else{                    $this->array_return['ResultType']=$this::__ERROR__;                    $this->array_return['Message']="修改失败";                }            }        }        return json($this->array_return);    }    /**     * 收藏列表     */    public function collection()    {        $list=$this->cards_logic->getCollectionData($this->userInfo['id']);        $list['user_no']= $this->member_mod->where('id='.$this->userInfo['member_id'])->getField('user_no');        $list['vip_name']=Db::table('s_vip_group')->where('id='.$this->userInfo['vip_group_id'])->getField('vip_name');        if(!empty($list))        {            $this->array_return['ResultType']=self::__OK__;            $this->array_return['Message']="获取收藏列表成功";            $this->array_return['AppendData']=$list;        }else{            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="获取收藏列表失败";            $this->array_return['AppendData']=null;        }        return json($this->array_return);    }    /**     * 收藏删除     */    public function del_collection()    {        $object_id = $this->_reqparam['object_id'];        if($object_id){            $res = Db::table('s_collection')->where(array('user_id'=>$this->userInfo['id'],'object_id'=>$object_id))->delete();            if($res){                $this->array_return['ResultType']=self::__OK__;                $this->array_return['Message']="删除成功";            }else {                $this->array_return['ResultType'] = self::__ERROR2__;                $this->array_return['Message'] = "删除失败";            }        }else{            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="缺少参数";        }        return json($this->array_return);    }    /**     * 收藏备注     * */    public function bei_collection()    {        $object_id = $this->_reqparam['object_id'];        $name = $this->_reqparam['name'];        if(isset($object_id) && isset($name)){            $res = Db::table('s_collection')->where(array('user_id'=>$this->userInfo['id'],'object_id'=>$object_id))->save(array('name'=>$name));            if($res){                $this->array_return['ResultType']=self::__OK__;                $this->array_return['Message']="操作成功";            }else {                $this->array_return['ResultType'] = self::__ERROR2__;                $this->array_return['Message'] = "操作失败";            }        }else{            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="缺少参数";        }        return json($this->array_return);    }    /**     * 留言列表     */    public function myMessage()    {        if($this->_reqparam['user_id'] >0 && $this->_reqparam['user_id']!=$this->userInfo['id']){// 给别人的留言            $where = array('b.object_id'=>$this->userInfo['id'],'b.user_id'=>$this->_reqparam['user_id']);        }else {            // 别人给我的留言            $where = array('b.user_id'=>$this->userInfo['id']);        }        $list = Db::table('s_blog')->alias('b')->join('left join s_user_detail u on u.id = b.object_id')               ->field('b.id,u.nick_name,b.add_time,b.content,b.is_read,u.headimg')               ->order('b.add_time desc')->where($where)->select();                        foreach ($list as $k=>$v){            $list[$k]['add_time'] = date("Y-m-d H:i",$v['add_time']);        }        if(!empty($list))        {            $this->array_return['ResultType']=self::__OK__;            $this->array_return['Message']="获取留言列表成功";            $this->array_return['AppendData']=$list;        }else{            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="获取留言列表失败";            $this->array_return['AppendData']=null;        }        return json($this->array_return);    }    /**     * 留言详情     */    public function messageInfo()    {        $model = Db::table('s_blog');        if($this->_reqparam['user_id'] == $this->userInfo['id']){            $model->where(array('id'=>$this->_reqparam['msg_id']))->save(array('is_read'=>1));        }        $list = $model->alias('b')->join('left join s_user_detail u on u.id = b.object_id')               ->join('left join s_member m on m.id = u.member_id')->field('b.id,u.nick_name,b.add_time,b.content,m.phone')               ->where(array('b.id'=>$this->_reqparam['msg_id']))->select();        foreach ($list as $k=>$v){            $list[$k]['add_time'] = date("Y-m-d H:i",$v['add_time']);        }        if(!empty($list))        {            $this->array_return['ResultType']=self::__OK__;            $this->array_return['Message']="获取留言详情成功";            $this->array_return['AppendData']=$list;        }else{            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="获取留言详情失败";            $this->array_return['AppendData']=null;        }        return json($this->array_return);    }    /**     * 添加留言     */    public function addMessage()    {        $user_id = $this->_reqparam['user_id'];//被留言的人        $content = $this->_reqparam['content'];//内容        if($user_id && $content){           $list = $this->user_logic->addBlog($user_id,$this->userInfo['id'],$content);            if($list)            {                $this->array_return['ResultType']=self::__OK__;                $this->array_return['Message']="添加成功";            }else{                $this->array_return['ResultType']=self::__ERROR__;                $this->array_return['Message']="添加失败";            }        }else{            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="缺少参数";        }        return json($this->array_return);    }    /**     *  删除     */    public function msgDelete()    {        if($this->_reqparam['msg_id']){            $list = Db::table('s_blog')->where(array('id'=>$this->_reqparam['msg_id']))->delete();            if($list)            {                $this->array_return['ResultType']=self::__OK__;                $this->array_return['Message']="删除成功";            }else{                $this->array_return['ResultType']=self::__ERROR__;                $this->array_return['Message']="删除失败";            }        }else{            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="缺少参数";        }        return json($this->array_return);    }    /**     *  标记已读     */    public function msgRead()    {        if($this->_reqparam['msg_id']){            $list = Db::table('s_blog')->where(array('id'=>$this->_reqparam['msg_id']))->save(array('is_read'=>1));            if($list)            {                $this->array_return['ResultType']=self::__OK__;                $this->array_return['Message']="标记已读";            }else{                $this->array_return['ResultType']=self::__ERROR__;                $this->array_return['Message']="操作失败";            }        }else{            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="缺少参数";        }                return json($this->array_return);    }    public function MyFriends()    {        $where = $this->request;        $where['user_id'] = $this->userInfo['id'];        $list = $this->cards_logic->getCards($where);        if(!empty($list))        {            $this->array_return['ResultType']=self::__OK__;            $this->array_return['Message']="获取网夹列表成功";            $this->array_return['AppendData']=$list;        }else{            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="获取网夹列表失败";            $this->array_return['AppendData']=null;        }                return json($this->array_return);    }        public function DeleteMyFriends()    {        $where = $this->request;        if(!isset($this->_reqparam['id']))        {            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="没有选择要删除的朋友！";            return json($this->array_return);        }else{            $where['id']=$this->_reqparam['id'];        }        //$where['user_id'] = $this->userInfo['id'];        //TODO:删除朋友时没有加userid条件，删除朋友条件中除了要有ID，还应该有user_id        $result =$this->cards_logic->delCards($where);        if(!empty($result))        {            $this->array_return['ResultType']=self::__OK__;            $this->array_return['Message']="删除朋友成功";            $this->array_return['AppendData']=$result;        }else{            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="删除朋友失败";            $this->array_return['AppendData']=null;        }                return json($this->array_return);    }    public function ViewMyFriend()    {        $where = $this->request;        if(!isset($this->_reqparam['id']))        {            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="没有选择要查看的朋友！";            return json($this->array_return);        }else{            $where['id']=$this->_reqparam['id'];        }        //$where['user_id'] = $this->userInfo['id'];        //TODO:删除朋友时没有加userid条件，查看朋友条件中除了要有ID，还应该有user_id        $result =$this->cards_logic->getCardsInfo($where);        if(!empty($result))        {            $this->array_return['ResultType']=self::__OK__;            $this->array_return['Message']="查看朋友成功";            $this->array_return['AppendData']=$result;            //‌‌$payinfo['obj']['pra']        }else{            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="获取朋友资料失败";            $this->array_return['AppendData']=null;        }        return json($this->array_return);    }    public function AddTrading()    {        $data=array();        $data['user_id']=$this->userInfo['id'];        if(!isset($this->_reqparam['tradId']))        {            $object_id =  $this->user_mod->where(array('unionid'=>$this->_reqparam['object_unionid']))->getField('id');            if(!$object_id){                $this->array_return['ResultType']=self::__ERROR__;                $this->array_return['Message']="要交换V网的朋友的资料没有找到！";                return json($this->array_return);            }            $data['object_id']=$object_id;        }else        {            $object_user=$this->user_logic->getUserInfoOption(array('spopenid'=>$this->_reqparam['tradId']));            if(empty($object_user))            {                $this->array_return['ResultType']=self::__ERROR__;                $this->array_return['Message']="要交换V网的朋友的资料没有找到！";                return json($this->array_return);            }            $data['object_id']=$object_user['id'];        }        $result = Db::table('s_collection')->where(array('user_id'=>$this->userInfo['id'],'object_id'=>$data['object_id']))->getField('id');        if(!$result){            $result=$this->cards_logic->addCollection($this->userInfo['id'],$data['object_id'],1);        }        if($result){//通过分享            if($this->_reqparam['notice'])            {                $data['msg']=$this->_reqparam['notice'];                $result1=$this->cards_logic->applyCards($data);                if($result1){                    $this->array_return['Message']='交换V网成功！';                    $this->array_return['ResultType']=self::__OK__;                }else{                    $this->array_return['Message']='请勿重复添加！';                    $this->array_return['ResultType']=self::__ERROR__;                }            }else {                $this->array_return['Message']='加入收藏成功！';                $this->array_return['ResultType']=self::__OK__;            }        }else{            $this->array_return['Message']='操作失败';            $this->array_return['ResultType']=self::__ERROR__;        }                return json($this->array_return);    }    public function DeleteMenu()    {        $where = $this->request;        if(!isset($this->_reqparam['id']))        {            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="没有选择要删除的菜单！";            return json($this->array_return);        }else{            $where['id']=$this->_reqparam['id'];        }        $result =$this->user_logic->ApiDelUsersNav($where);        if(!empty($result))        {            $this->array_return['ResultType']=self::__OK__;            $this->array_return['Message']="删除菜单成功";            $this->array_return['AppendData']=$result;        }else{            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="删除菜单失败";            $this->array_return['AppendData']=null;        }        return json($this->array_return);    }    public function DeleteContent()	{        $where = $this->request;        if(!isset($this->_reqparam['id']))		{            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="没有选择要删除的内容！";            return json($this->array_return);        }else{            $where['id']=$this->_reqparam['id'];        }        $result =$this->user_logic->ApiDelUsersContent($where);        if(!empty($result))        {            $this->array_return['ResultType']=self::__OK__;            $this->array_return['Message']="删除内容成功";            $this->array_return['AppendData']=$result;        }else{            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="删除内容失败";            $this->array_return['AppendData']=null;        }        return json($this->array_return);    }    public function Share()    {        $openid=trim(input('name'));        $recreate=$this->_reqparam['recreate'];        if(!$openid)        {            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="没有用户微信授权";            return json($this->array_return);        }        if(!$recreate)        {            $recreate=0;        }        $res = $this->user_logic->GetOrCreateShareImg($openid,$recreate);        $this->assign('img',$res);        $this->display("Home@Card:myEwm");    }    /**     * 退出     */    public function Logout()    {    	       	$this->array_return['ResultType']=self::__ERROR__;        	$this->array_return['Message']="解绑失败";        $a=  $this->user_mod->save(array('id'=>$this->userInfo['id'],'is_quit'=>1,'spopenid'=>''));        $b =  $this->member_mod->where(array('id'=>$this->userInfo['member_id']))->save(array('spopenid'=>''));        if($a!==false && $b!==false)        {            $this->array_return['ResultType']=self::__OK__;            $this->array_return['Message']="解绑成功";            return json($this->array_return);        }                return json($this->array_return);    }	    /**    * 更新地理位置    */    public function uptLocation()    {	   $latitude = isset($_POST['latitude']) ? $_POST['latitude'] : 0;	   $longitude = isset($_POST['longitude']) ? $_POST['longitude'] : 0;	   if(!$latitude || !$longitude)	   {            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="缺少参数";            return json($this->array_return);	   }	              	   $this->array_return['ResultType']=self::__ERROR__; 	   $this->array_return['Message']="地理位置更新失败";         $res = $this->user_mod->where(array('id'=>$this->userInfo['id']))->save(array('latitude'=>$latitude,'longitude'=>$longitude));       if($res)       {        	$this->array_return['ResultType']=self::__OK__;       		$this->array_return['Message']="地理位置更新成功";          }              return json($this->array_return);    }}