<?phpnamespace app\api\controller;use app\common\controller\ApiBase;use think\Db;class SignUpApi extends ApiBase{    /**     * 报名列表     */    public function sign_up_list()    {        $start = $this->_reqparam['start']?$this->_reqparam['start']:0;        $length = $this->_reqparam['length']?$this->_reqparam['length']:10;        $is_my = $this->_reqparam['is_my'];        $where = array();        if($is_my == 1){            $where['s.user_id'] = $this->userInfo['id'];        }                $list = Db::table('s_sign_up')->alias('s')->join('left join s_sign_user su on su.sign_id = s.id')            ->field('s.id,s.title,s.cover_img,s.look,s.addtime,count(su.sign_id) as join_num')            ->where($where)->group('s.id')->order('s.id desc')->limit($start,$length)->select();                    foreach ($list as $k=>$v){            $list[$k]['addtime'] = date('Y-m-d',$v['addtime']);        }        if ($list) {            $this->array_return['ResultType'] = self::__OK__;            $this->array_return['Message'] = "操作成功";            $this->array_return['AppendData'] = $list;        } else {            $this->array_return['ResultType'] = self::__ERROR2__;            $this->array_return['Message'] = "操作失败";        }                return json($this->array_return);    }    /**     * 添加报名列表(只能添加  不能修改)     */    public function add_sign_up()    {        //标题        if(isset($this->_reqparam['title'])){            $data['title'] = $this->_reqparam['title'];        }        //封面        if(isset($this->_reqparam['cover_img'])){            $data['cover_img'] = $this->_reqparam['cover_img'];        }        //内容        if(isset($this->_reqparam['content'])){            $data['content'] = htmlspecialchars_decode($this->_reqparam['content']);        }                if($data['title'] && $data['cover_img'] && $data['content']){            $data['user_id'] = $this->userInfo['id'];            $data['addtime'] = time();            $res = Db::table('s_sign_up')->insert($data);            if ($res) {                $this->array_return['ResultType'] = self::__OK__;                $this->array_return['Message'] = "操作成功";                $this->array_return['AppendData'] = $res;            } else {                $this->array_return['ResultType'] = self::__ERROR2__;                $this->array_return['Message'] = "操作失败";            }        }else{            $this->array_return['ResultType'] = self::__ERROR__;            $this->array_return['Message'] = "缺少参数";        }                return json($this->array_return);    }        /**     *报名参数填写(只能添加    不能修改)     */    public function sign_up_detail()    {        $sign_id = $this->_reqparam['sign_id'];        $title = $this->_reqparam['title'];//数组        if(isset($sign_id) && isset($title)){            $old = Db::table('s_sign_detail')->where(array('sign_id'=>$sign_id))->find();            if($old){                $this->array_return['ResultType'] = self::__ERROR__;                $this->array_return['Message'] = "请勿重复添加";                return json($this->array_return);            }            $new_detail = array();            foreach ($title as $t) {                $new_detail[] = array('sign_id' => $sign_id, 'title' => $t, 'addtime' => time());            }            $res = Db::table('s_sign_detail')->addAll($new_detail);            if ($res) {                $this->array_return['ResultType'] = self::__OK__;                $this->array_return['Message'] = "操作成功";            } else {                $this->array_return['ResultType'] = self::__ERROR2__;                $this->array_return['Message'] = "操作失败";            }        }else{            $this->array_return['ResultType'] = self::__ERROR__;            $this->array_return['Message'] = "缺少参数";        }                return json($this->array_return);    }        /**     *单个报名内容详情     */    public function sign_detail()    {        $sign_id = $this->_reqparam['sign_id'];//报名id        $is_my = $this->_reqparam['is_my'];        if($sign_id){            $list = Db::table('s_sign_up')->alias('s')                ->join('left join s_user_detail u on u.id = s.user_id')                ->join('left join s_sign_user su on su.sign_id = s.id')                ->field('s.id,s.cover_img,s.title,s.content,s.look,s.addtime,u.unionid,u.nick_name,u.headimg,count(su.sign_id) as join_count')                ->group('s.id')                ->where(array('s.id'=>$sign_id))                ->find();            $list['content'] = htmlspecialchars_decode($list['content']);            $list['addtime'] = date("Y-m-d",$list['addtime']);            if($is_my){                $list['detail'] = Db::table('s_sign_user')->field('content,addtime')->where(array('sign_id'=>$list['id']))->select();                foreach ($list['detail'] as $k=>$v){                    $list['detail'][$k]['content'] = json_decode($v['content'],true);                    $list['detail'][$k]['addtime'] = date('Y-m-d',$v['addtime']);                }            }else{                Db::table('s_sign_up')->where(array('id'=>$sign_id))->setInc('look');                $list['detail'] = Db::table('s_sign_detail')->field('title')->where(array('sign_id'=>$list['id']))->select();            }            if ($list) {                $this->array_return['ResultType'] = self::__OK__;                $this->array_return['Message'] = "操作成功";                $this->array_return['AppendData'] = $list;            } else {                $this->array_return['ResultType'] = self::__ERROR2__;                $this->array_return['Message'] = "操作失败";            }        }else{            $this->array_return['ResultType'] = self::__ERROR__;            $this->array_return['Message'] = "缺少参数";        }                return json($this->array_return);    }        /**     * 报名     */    public function add_sign_user()    {        $content= $this->_reqparam['content'];//数组        $sign_id= $this->_reqparam['sign_id'];//报名id        if($sign_id && $content){            $res = Db::table('s_sign_user')->insert(array('sign_id'=>$sign_id,'content'=>json_encode($content),'addtime'=>time()));            if ($res) {                $this->array_return['ResultType'] = self::__OK__;                $this->array_return['Message'] = "操作成功";            } else {                $this->array_return['ResultType'] = self::__ERROR2__;                $this->array_return['Message'] = "操作失败";            }        }else{            $this->array_return['ResultType'] = self::__ERROR__;            $this->array_return['Message'] = "缺少参数";        }                return json($this->array_return);    }        /**     * 删除报名     */    public function del_sign()    {        $sign_id = $this->_reqparam['sign_id'];        if($sign_id){            $res = Db::table('s_sign_up')->where(array('user_id'=>$this->userInfo['id'],'id'=>$sign_id))->delete();            if($res){                Db::table('s_sign_user')->where(array('sign_id'=>$sign_id))->delete();                Db::table('s_sign_detail')->where(array('sign_id'=>$sign_id))->delete();                $this->array_return['ResultType'] = self::__OK__;                $this->array_return['Message'] = "操作成功";            } else {                $this->array_return['ResultType'] = self::__ERROR2__;                $this->array_return['Message'] = "操作失败";            }        }else{            $this->array_return['ResultType'] = self::__ERROR__;            $this->array_return['Message'] = "缺少参数";        }                return json($this->array_return);    }}