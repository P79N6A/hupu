<?phpnamespace app\common\controller;use think\Cache;use think\Controller;use think\Db;use think\facade\Session;/** * Api 基类控制器 */class ApiBase  extends Controller{	    /**     * 初始化方法     */    const __OK__ = '0'; //请求成功    const __ERROR__ = '1'; //参数错误    const __ERROR1__ = '2'; //没有绑定    const __ERROR2__ = '3';//数据库错误    const __ERROR4__ = '4';//未查询到数据    const __ERROR5__ = '5';//条件不符合    public $code_expire_time = 60;//验证码过期时间    public $array_return = array("ResultType"=>1,"Message"=>"success","AppendData"=>[]);    public $userInfo;    public $_reqparam;    public function initialize()    {    	$this->_reqparam = $this->request->param();        $this->userInfo = Session::has('user_info') ? Session::get('user_info') : array();        $act_name = strtolower($this->request->action());        $cnt_name = strtolower($this->request->controller());        $conf = config('NO_APP_LOGIN');     	        if(isset($conf[$cnt_name]) && in_array($act_name,$conf[$cnt_name]))         {    		return ;	    }	    	    extract($this->_reqparam);        if (!isset($unionid) && !isset($spopenid))         {       	        	$this->array_return['ResultType'] = self::__ERROR__;            $this->array_return['Message'] = "非法访问";            $this->array_return['data'] = null;            echo json_encode($this->array_return);die();        }        if (!$this->userInfo)         {        	$where = isset($unionid) && $unionid ? array('unionid' => $unionid) : array('spopenid' => $spopenid);        	$uid = Db::table('s_member')->where($where)->value('id');         	if( $uid ) {        		$uinfo = Db::table('s_user_detail')->field('user_id as id,headimg,nick_name')->where(array('user_id'=>$uid))->find();				session('user_info', $uinfo);				$this->userInfo = $uinfo;				return ;        	}        	        	$this->array_return['ResultType'] = self::__ERROR__;	        $this->array_return['Message'] = "用户不存在";	        $this->array_return['data'] = null;	        echo json_encode($this->array_return);die();        }     }    public function checklogin($uid, $token)    {        $where = array();        $where['id'] = array('EQ', $uid);        $res = Db::table('s_userInfo')->where($where)->find();        if ($res['token'] != $token) {            Util::response('1009', '请重新登录', null);            exit();        } else {            unset($res['passwd']);            return $res;        }    }    /**     * 前段用户注销     */    public function logQianOut()    {        // 清楚所有session        session(null);        echo json_encode('注销成功');    }}