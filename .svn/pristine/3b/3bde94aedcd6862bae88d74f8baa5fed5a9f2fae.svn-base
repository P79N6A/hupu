<?php/** 广告管理 */namespace app\home\controller;use app\common\controller\HomeBase;use think\Db;class Advertisement extends HomeBase{    /**     * 文章广告列表     */    public function listArticleAD()    {        $adverts = Db::table('s_advert')->where(['user_id' => $this->userInfo['id']])->select();        $userInfo = Db::table('s_user_info')->where(['id' => $this->userInfo['id']])->find();        $this->assign('list', $adverts);        $this->assign('article_advert', $userInfo['article_advert']);        return  $this->fetch();    }    /**     * 广告可编辑列表     */    public function editList()    {        return  $this->fetch();    }    /**     * 广告可编辑列表     */    public function edit()    {        if(isPOST) {            $advert = Db::table('s_advert')->where(['id' => Input('id')])->find();            if (!$advert) {                return json(['status' => 0, 'msg' => '编号错误']);            }            $image = $this->imgUpload(Input('img'));            $image = $image['data']['path'];            if ($image) {                $advert['thumb'] = $image;            }            $advert['jump_url'] = Input('url');            $advert['title'] = Input('title');            $result = Db::table('s_advert')->update($advert);            if ($result === false) {                return json(['status' => 0, 'msg' => '编辑失败']);            }            return json(['status' => 1, 'msg' => '编辑成功']);        }    }    /**     *  添加(修改)文章广告     */    public function addArticleAD()    {        if(isPOST){            $image = $this->imgUpload(Input('img'));            if ($image['code'] != 200) {                return json(['status' => 0, 'msg' => $image['msg']]);            }            $image = $image['data']['path'];            if (!$image) {                return json(['status' => 0, 'msg' => '上传失败']);            }            $data['thumb'] = $image;            $data['user_id'] = $this->userInfo['id'];            $data['title'] = Input('title');            $data['jump_url'] = Input('url');            $data['add_time'] = time();            $result = Db::table('s_advert')->insert($data);            if (!$result) {                return json(['status' => 0, 'msg' => '添加失败']);            }            return json(['status' => 1, 'msg' => '添加成功']);        }                return  $this->fetch();    }    /**     *  删除文章广告     */    public function delArticleAD()    {        Db::table('s_advert')->where(['id' =>Input('id')])->delete();        return json(['status' => 1, 'msg' => '删除成功']);    }    /**     *  获取文章广告     */    public function getArticleAD()    {        $advert = Db::table('s_advert')->where(['id' =>Input('id')])->find();        return json(['status' => 1, 'msg' => '获取成功', 'data' => $advert]);    }    //上传图片    protected  function imgUpload($base64img)    {        $base64_image = str_replace(' ', '+', $base64img);        //post的数据里面，加号会被替换为空格，需要重新替换回来，如果不是post的数据，则注释掉这一行        if (preg_match('/^(data:\s*image\/(\w+);base64,)/', $base64_image, $result))        {            //服务器文件存储路径            if(substr($_SERVER['HTTP_HOST'],0,1) == 'w'){                $start_name = 'trade';            }else{                $start_name = 'test';            }            $Upload = new \Admin\Controller\UploadsController();            if($result[2] == 'jpeg'){                $save_name = $start_name.'/'.date('Ymd').'/'.time().rand(1,9999).'.jpg';            }else{                $save_name = $start_name.'/'.date('Ymd').'/'.time().rand(1,9999).'.'.$result[2];            }            $imgPath = $Upload->Uploads($save_name,str_replace($result[1], '', $base64_image),1);            if($imgPath){                $ReData['code'] ='200';//相应状态吗                $ReData['msg'] = '上传成功';                $ReData['data']['path'] = $imgPath;            }else{                $ReData['code'] ='-200';//相应状态吗                $ReData['msg'] = '上传失败!';                $ReData['data']['base64img'] = $base64img;            }        }else{            $ReData['code'] ='-400';//相应状态吗            $ReData['msg'] = '传输数据格式错误';            $ReData['data']['base64img'] = $base64img;        }        return $ReData;    }    /**     *  设置文章广告     */    public function setArticleAD()    {        $userInfo = Db::table('s_user_info')->where(['id' => $this->userInfo['id']])->find();        $userInfo['article_advert'] = Input('article_advert');        $result = Db::table('s_user_info')->update($userInfo);        if ($result === false) {            return json(['status' => 0, 'msg' => '保存失败']);        }                return json(['status' => 1, 'msg' => '保存成功']);    }}