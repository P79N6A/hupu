<?php/** * Created by PhpStorm. * User: admin * Date: 2017/12/7 * Time: 0:16  */namespace app\api\controller;use app\common\controller\ApiBase;use app\api\logic\User  as userLogic;use app\api\logic\Gcard  as gcardLogic;use app\api\logic\Cards  as cardLogic;use app\api\logic\Trade  as tradeLogic;use app\api\logic\MsgList  as msgLogic;use app\api\logic\ArticleList  as artLogic;use app\common\event\imgUpload  as imgModel;class Content extends  ApiBase{	private $gcard_logic = null;	private $art_logic = null;	private $msg_logic = null;	private $art_model = null;	private $user_logic = null;	private $cards_logic = null;	private $trade_logic = null;	private $img_mod = null;	    public function initialize()    {        parent::initialize();        require_once VENDOR_PATH.'/Weixin/class.wx_sdk_handler.php';//引入微信Api        require_once VENDOR_PATH.'/Weixin/class.wx_network.php'; //引入微信配置文件        require_once VENDOR_PATH.'/Weixin/class.wx_open_api.php';        require_once VENDOR_PATH.'/Weixin/interface.wx_database.php';		require_once EXTEND_PATH.'/Baidu/Geocoding.php';				$this->gcard_logic = new gcardLogic();		$this->art_logic = new artLogic();		$this->msg_logic = new msgLogic();		$this->art_model = new artModel();		$this->user_logic = new userLogic();		$this->cards_logic = new cardLogic();		$this->trade_logic = new tradeLogic();		$this->img_mod = new imgModel();		        // 初始化SDK        $opt = array(            'app_id' => XCX_APP_ID,            'app_secret' => XCX_APP_SECRET,            'rsa_private_key' => XCX_RSA_PRIVATE_KEY,            'salt' => XCX_SALT,            'database' => $this->db,            'delegate' => $this        );        $this->sdk = new \WXSDKHandler($opt);        $actionName = strtolower($this->request->action());        $noLogin=array();        if(!in_array($actionName,$noLogin))        {            if($this->_reqparam['spopenid']) {                $this->userInfo=$this->user_logic->getUserInfoOption(array('spopenid'=>$this->_reqparam['spopenid']));            }elseif($this->_reqparam['unionid']){                $this->userInfo = Db::table('s_user_detail')->where(array('unionid'=>$this->_reqparam['unionid']))->find();            }else{                $this->array_return['ResultType']=self::__ERROR__;                $this->array_return['Message']="非法访问";                $this->array_return['data']=null;                return json($this->array_return);            }            if(!$this->userInfo)            {                $this->array_return['ResultType']=self::__ERROR__;                $this->array_return['Message']="没有该用户或登录失败";                $this->array_return['data']=null;                return json($this->array_return);            }else {                $this->_reqparam['userInfo']=$this->userInfo;            }        }    }    public function UploadNavImg()    {              $this->array_return['ResultType']=self::__ERROR__;        $this->array_return['Message']='没有上传文件！';        $this->array_return['AppendData']=[];        if(!empty($_FILES['file']['name'])){            $img=$this->img_mod->updateImg_file($_FILES['file'],'xcx_user_nav_img');            $this->array_return['ResultType']=self::__OK__;            $this->array_return['Message']='上传成功！';            $this->array_return['AppendData']=$img;        }        return json($this->array_return);    }    public function UploadContentImg()    {                        $this->array_return['ResultType']=self::__ERROR__;        $this->array_return['Message']='没有上传文件！';        $this->array_return['AppendData']=[];        if(!empty($_FILES['file']['name'])){            $img=$this->img_mod->updateImg_file($_FILES['file'],'xcx_user_content_img');            $this->array_return['ResultType']=self::__OK__;            $this->array_return['Message']='上传成功！';            $this->array_return['AppendData']=$img;        }        return json($this->array_return);    }    public function Photo2Card()    {    	            	$this->array_return['ResultType']=self::__ERROR__;        $this->array_return['Message']='没有上传文件！';        $this->array_return['AppendData']=[];        if(!empty($_FILES['file']['name'])){            $img = $this->img_mod->update_file($_FILES['file'],'xcx_user_photo2card');            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']='上传失败！';            if($img)            {                $result=$this->fillCard($img);                if(is_array($result))                {                    $this->array_return['ResultType']=self::__OK__;                    $this->array_return['Message']='识别成功';                    $this->array_return['AppendData']=$result;                }else{                    $this->array_return['ResultType']=self::__ERROR__;                    $this->array_return['Message']=$result;                }            }        }        return json($this->array_return);    }    public function UploadMycardImg()    {            	$this->array_return['ResultType']=self::__ERROR__;        $this->array_return['Message']='没有上传文件！';        $this->array_return['AppendData']=[];        if(!empty($_FILES['file']['name'])){            $img=$this->img_mod->updateImg_file($_FILES['file'],'xcx_user_img');            $this->array_return['ResultType']=self::__OK__;            $this->array_return['Message']='上传成功！';            $this->array_return['AppendData']=$img;        }        return json($this->array_return);    }    public function UploadNavVideo()    {        if(!empty($_FILES['file']['name'])){            $img=$this->img_mod->update_file($_FILES['file'],'xcx_user_nav_video');            $this->array_return['ResultType']=self::__OK__;            $this->array_return['Message']='上传成功！';            $this->array_return['AppendData']=$img;            return json($this->array_return);        }        $this->array_return['ResultType']=self::__ERROR__;        $this->array_return['Message']='没有上传文件！';        $this->array_return['AppendData']=[];        return json($this->array_return);    }    public function UploadContentVideo()    {        $this->array_return['ResultType']=self::__ERROR__;        $this->array_return['Message']='没有上传文件！';        $this->array_return['AppendData']=[];        if(!empty($_FILES['file']['name']))        {            $img=$this->img_mod->update_file($_FILES['file'],'xcx_user_content_video');            $this->array_return['ResultType']=self::__OK__;            $this->array_return['Message']='上传成功！';            $this->array_return['AppendData']=$img;        }        return json($this->array_return);    }    public function getExeName($fileName)    {        $pathinfo      = pathinfo($fileName);        return strtolower($pathinfo['extension']);    }    private function fillCard($url)    {        if($url!=''){            $url=substr($url,strlen(get_current_Host())+1);            $res=bcard_query($url);            if($res['status']!=0){                $message="识别名片失败,".$res['msg'];            }else{                $data = $res['result'];                if(isset($data['mobile'])){                    //手机号码                    $_data['mobile']=implode(",",$data['mobile']);                }                if(isset($data['position'])){                    //职位/部门                    $_data['position']=implode(",",$data['position']);                }                if(isset($data['name'])){                    //姓名                    $_data['nick_name']=$data['name'];                }                if(isset($data['tel'])){                    //固话                    $_data['telephone']=implode(",",$data['tel']);                }                if(isset($data['website'])){                    //网址                    $_data['site']=implode(",",$data['website']);                }                if(isset($data['address'])){                    //地址                    $_data['address']=implode(",",$data['address']);                }                if(isset($data['company'])){                    //公司名称                    $_data['company']=implode(",",$data['company']);                }                if(isset($data['email'])){                    //邮箱                    $_data['email']=implode(",",$data['email']);                }                return $data;            }        }else{            return "识别名片失败,因为没有成功上传图片";        }    }    public function GreetingCardTypes()    {    	$this->array_return['ResultType']=self::__OK__;        $this->array_return['Message']="获取贺卡分类成功";        $this->array_return['AppendData']=$res;        $res = $this->gcard_logic->getHomeGcard_xcx();        if(!$res)        {            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="贺卡分类为空";            $this->array_return['AppendData']=null;        }        return json($this->array_return);    }    /*    * javatom    * 20180621    * 分页查询我的贺卡数据    *@thispage 当前所在页     *    * */    public function getMyGcardLists()    {    	$this->array_return['ResultType']=self::__OK__;        $this->array_return['Message']="获取我的贺卡列表成功";        $this->array_return['AppendData']=$res;        $res = $this->gcard_logic->getMyGcardList_xcx($this->request);        if(!$res)        {            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="您没有贺卡";            $this->array_return['AppendData']=null;        }        return json($this->array_return);    }    public function GreetingCardTemplates()    {        $res = $this->gcard_logic->getGCardList_xcx($this->request);        if(!$res)        {            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="该贺卡不存在";            $this->array_return['AppendData']=null;        }else{            $this->array_return['ResultType']=self::__OK__;            $this->array_return['Message']="获取贺卡信息成功";            $this->array_return['AppendData']=$res;        }        return json($this->array_return);    }    public function CreateGCard()    {        if(empty($this->_reqparam['gives']))        {            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="收卡人没填！";            return json($this->array_return);        }        if(empty($this->_reqparam['blessings']))        {            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="祝福语没填！";            return json($this->array_return);        }        if(empty($this->_reqparam['sends']))        {            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="发卡人没填！";            return json($this->array_return);        }        if(empty($this->_reqparam['audio']))        {            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="背景音乐没填！";            return json($this->array_return);        }        if(empty($this->_reqparam['header']))        {            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="头象没填！";            return json($this->array_return);        }        if(empty($this->_reqparam['templateId']))        {            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="没有选择模板！";            return json($this->array_return);        }        $res = $this->gcard_logic->addUsersGcard_xcx($this->request);        if(!$res)        {            if(empty($this->_reqparam['id']))            {                $this->array_return['ResultType']=self::__ERROR__;                $this->array_return['Message']="添加贺卡失败";                $this->array_return['AppendData']=null;            }else{                $this->array_return['ResultType']=self::__ERROR__;                $this->array_return['Message']="更新贺卡失败";                $this->array_return['AppendData']=null;            }        }else{            if(empty($this->_reqparam['id']))            {                $this->array_return['ResultType']=self::__OK__;                $this->array_return['Message']="添加贺卡成功";                $this->array_return['AppendData']=$res;            }else{                $this->array_return['ResultType']=self::__OK__;                $this->array_return['Message']="更新贺卡成功";                $this->array_return['AppendData']=$res;            }        }        return json($this->array_return);    }    public function MyGreetingCards()    {        $res = $this->gcard_logic->getUsersGcardInfoList_xcx($this->request);        if(!$res)        {            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="您还没有制作过贺卡";            $this->array_return['AppendData']=null;        }else{            $this->array_return['ResultType']=self::__OK__;            $this->array_return['Message']="获取贺卡信息成功";            $this->array_return['AppendData']=$res;        }        return json($this->array_return);    }    public function MyOneGreetingCards()    {        if(empty($this->_reqparam['id']))        {            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="没有选择贺卡！";            return json($this->array_return);        }        $res = $this->gcard_logic->getOneUsersGcard($this->request);        if(!$res)        {            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="您没有该贺卡";            $this->array_return['AppendData']=null;        }else{            $this->array_return['ResultType']=self::__OK__;            $this->array_return['Message']="获取贺卡信息成功";            $this->array_return['AppendData']=$res;        }        return json($this->array_return);    }    public function OneGreetingCard()    {        if(empty($this->_reqparam['id']))        {            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="没有选择贺卡！";            return json($this->array_return);        }        $res = $this->gcard_logic->oneGreetingCard_xcx($this->request);        if(!$res)        {            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="您没有该贺卡";            $this->array_return['AppendData']=null;        }else{            $this->array_return['ResultType']=self::__OK__;            $this->array_return['Message']="获取贺卡信息成功";            $this->array_return['AppendData']=$res;        }        return json($this->array_return);    }    public function DeleteMyGreetingCard()    {        if(empty($this->_reqparam['id']))        {            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="没有选择贺卡！";            return json($this->array_return);        }        $this->_reqparam['user_id']=$this->userInfo['id'];        $res = $this->gcard_logic->delUsersGcard($this->request);        if(!$res)        {            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="您没有该贺卡，删除失败";            $this->array_return['AppendData']=null;        }else{            $this->array_return['ResultType']=self::__OK__;            $this->array_return['Message']="删除贺卡信息成功";            $this->array_return['AppendData']=$res;        }        return json($this->array_return);    }    public function Getaudios()    {        $res = $this->gcard_logic->getMusicList($this->request);        if(!$res)        {            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="您没有该贺卡";            $this->array_return['AppendData']=null;        }else{            $this->array_return['ResultType']=self::__OK__;            $this->array_return['Message']="获取贺卡信息成功";            $this->array_return['AppendData']=$res;        }        return json($this->array_return);    }    public function AddVCard()    {        if(empty($this->_reqparam['name']))        {            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="真实姓名没有填写！";            return json($this->array_return);        }        if(empty($this->_reqparam['mobile']))        {            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="手机号没有填写！";            return json($this->array_return);        }        $this->_reqparam['telephone']=$this->_reqparam['mobile'];        $this->_reqparam['realname']=$this->_reqparam['name'];        $this->_reqparam['user_id'] = $this->userInfo['id'];        $this->_reqparam['site'] = $this->_reqparam['website'];        $this->_reqparam['type'] = 2;        $res = $this->cards_logic->addCards($this->request);        if(!$res)        {            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="添加卡片失败";            $this->array_return['AppendData']=null;        }else{            $this->array_return['ResultType']=self::__OK__;            $this->array_return['Message']="添加卡片成功";            $this->array_return['AppendData']=$res;        }                return json($this->array_return);    }    public function GetSqTypeList()    {        $where = array();        $orderby = array();        if(!isset($this->_reqparam['pid']))        {            array_push($where,array('parent_id'=>0));        }else{            array_push($where,array('parent_id'=>$this->_reqparam['pid']));        }        if(!isset($this->_reqparam['order']))        {            array_push($orderby,array('id'=>'asc'));        }else{            $temp=explode(',',$this->_reqparam['order']);            foreach ($temp as  $item)            {               $tempArray=explode(' ',$item);                $orderby[$tempArray[0]]= $tempArray[1];            }        }        $res = $this->trade_logic->getSqTypeList($where,$orderby);        $this->array_return['ResultType']=self::__ERROR__;        $this->array_return['Message']="获取行业分类失败";        $this->array_return['AppendData']=null;        if($res){            $this->array_return['ResultType']=self::__OK__;            $this->array_return['Message']="获取行业分类成功";            $this->array_return['AppendData']=$res;        }        return json($this->array_return);    }    public function GetTradsList()    {        $where=array('sq_is_search'=>1);        if(!empty($this->_reqparam['provinceid']))        {            $where['province_id']=$this->_reqparam['provinceid'];        }        if(!empty($this->_reqparam['cityid']))        {            $where['city_id']=$this->_reqparam['cityid'];        }        if(isset($this->_reqparam['sex']) && $this->_reqparam['sex'] != '-1')        {            $where['sex']=$this->_reqparam['sex'];        }        if(isset($this->_reqparam['age_id']) && $this->_reqparam['age_id'] != '-1')        {            $where['age_id']=$this->_reqparam['age_id'];        }        if(!empty($this->_reqparam['keyword']))        {        	$sql=" (nick_name like '%".$this->_reqparam['keyword']."%' or sq_keyword like '%".$this->_reqparam['keyword']."%')";            $where['_string']=empty($where['_string'])?$sql:$where['_string'].' and '.$sql;        }        if(!empty($this->_reqparam['typesid'])){            $array=explode(",", $this->_reqparam['typesid']);            $sql="";            foreach ($array as $key => $value) {                $sql.= "FIND_IN_SET('".$value."',sq_type_id)";                if($key!=(count($array)-1)){                    $sql.=" or ";                }            }            $where['_string']=empty($where['_string'])?$sql:$where['_string'].' and ('.$sql.')';        }        $begin_position = (intval($this->_reqparam['current_page_number'])-1)*intval($this->_reqparam['page_size']);        $limit=$begin_position.",".$this->_reqparam['page_size'];        $userList = Db::table('s_userInfo')->where($where)->limit($limit)->select();        foreach($userList as $k => $v) {            if (mb_strlen($v['position']) > 10) {                $userList[$k]['position'] = mb_substr($v['position'],0,10,'utf-8').'...';            }                    $userList[$k]['background_img']=ToOpenWxImage($userList[$k]['background_img']);            $userList[$k]['headimg']=ToOpenWxImage($userList[$k]['headimg']);            $userList[$k]['wx_ewm_url']=ToOpenWxImage($userList[$k]['wx_ewm_url']);            $userList[$k]['thumbhead']=ToOpenWxImage($userList[$k]['thumbhead']);            $userList[$k]['shareimg']=ToOpenWxImage($userList[$k]['shareimg']);            $userList[$k]['qrcodeimg']=ToOpenWxImage($userList[$k]['qrcodeimg']);        }        $res= $userList;        $this->array_return['ResultType']=self::__ERROR__;        $this->array_return['Message']="获取商脉失败";        $this->array_return['AppendData']=null;        if($res) {            $this->array_return['ResultType']=self::__OK__;            $this->array_return['Message']="获取商脉成功";            $this->array_return['AppendData']=$res;        }        return json($this->array_return);    }    public function GetMsgCount()    {        $where = array();        $where['user_id']=$this->userInfo['id'];//别人发给我        $where1['object_id']=$this->userInfo['id'];//我发给别人        if(isset($this->_reqparam['isreaded']))        {            $where['is_read']=$this->_reqparam['isreaded'];        }        if(!empty($this->_reqparam['status']))        {            $array=explode(",", $this->_reqparam['status']);            $sql="";            foreach ($array as $key => $value) {                $sql.= "status='".$value."'";                if($key!=(count($array)-1)){                    $sql.=" or ";                }            }            $where['_string']=$sql;            $where1['_string']=$sql;        }        $res = $this->msg_logic->getMsgCount($where,$where1);        $this->array_return['ResultType']=self::__ERROR__;        $this->array_return['Message']="获取数量失败";        $this->array_return['AppendData']=null;        if ($res) {            $this->array_return['ResultType']=self::__OK__;            $this->array_return['Message']="获取数量成功";            $this->array_return['AppendData']=$res;        }        return json($this->array_return);    }    public function GetMsgList()    {        $where=array();        $where['user_id']=$this->userInfo['id'];        if(isset($this->_reqparam['isreaded']))        {            $where['is_read']=$this->_reqparam['isreaded'];        }        if(!empty($this->_reqparam['keyword']))        {            $where['msg']=array('LIKE','%'.$this->_reqparam['keyword'].'%');        }        if(!empty($this->_reqparam['status'])){            $array=explode(",", $this->_reqparam['status']);            $sql="(";            foreach ($array as $key => $value) {                $sql.= "status='".$value."'";                if($key!=(count($array)-1)){                    $sql.=" or ";                }            }            $sql.=")";            $where['_string']=$sql;        }        if(!empty($this->_reqparam['types'])){            $array=explode(",", $this->_reqparam['types']);            $sql="(";            foreach ($array as $key => $value) {                $sql.= "type='".$value."'";                if($key!=(count($array)-1)){                    $sql.=" or ";                }            }            $sql.=")";            $where['_string']=empty($where['_string'])?$sql:$where['_string'].' and '.$sql;        }        $begin_position = (intval($this->_reqparam['current_page_number'])-1)*intval($this->_reqparam['page_size']);        $limit=$begin_position.",".$this->_reqparam['page_size'];        $orderby=array();        if(!isset($this->_reqparam['order']))        {            $orderby['id']='asc';        }else{            $temp=explode(',',$this->_reqparam['order']);            foreach ($temp as  $item)            {                $tempArray=explode(' ',$item);                $orderby[$tempArray[0]]= $tempArray[1];            }        }        if(empty($this->_reqparam['order']))        {            $res = $this->msg_logic->getMsgList_xcx($where,$limit);        }else{            $res = $this->msg_logic->getMsgList_xcx($where,$limit,$this->_reqparam['order']);        }        if(!$res)        {            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="获取消息列表失败";            $this->array_return['AppendData']=null;        }else{            $this->array_return['ResultType']=self::__OK__;            $this->array_return['Message']="获取消息列表成功";            $this->array_return['AppendData']=$res;        }                return json($this->array_return);    }    public function CatchArticle()    {        if(empty($this->_reqparam['url']))        {            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="要抓取的URL没有填写！";            return json($this->array_return);        }        $user_id=$this->userInfo['id'];        $res = $this->art_logic->captArticle($this->_reqparam['url'],$user_id);        $par=array('user_id'=>$user_id);        $par['id']=$res;        $res= $this->art_logic->getArticleInfo($par);        if(!$res)        {            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="软文抓取失败";            $this->array_return['AppendData']=null;        }else{            $res['thumb']=ToOpenWxImage($res['thumb']);            if(!empty($res['Advert']))            {                foreach ($res['Advert'] as  $key=>$value)                {                    $res['Advert'][$key]['thumb']=ToOpenWxImage($res['Advert'][$key]['thumb']);                }            }            if(!empty($res['promotion']))            {            	$res['promotion']['wx_ewm_url']=ToOpenWxImage($res['promotion']['wx_ewm_url']);                $res['promotion']['headimg']=ToOpenWxImage($res['promotion']['headimg']);            }            $this->array_return['ResultType']=self::__OK__;            $this->array_return['Message']="软文抓取成功";            $this->array_return['AppendData']=$res;        }        return json($this->array_return);    }    public function DeleteArticle()    {        if(empty($this->_reqparam['id']))        {            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="要删除的软文没有填写！";            return json($this->array_return);        }        $user_id=$this->userInfo['id'];        $this->_reqparam['user_id']=$user_id;        $res = $this->art_logic->delArticle($this->request);        if(!$res)        {            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="删除软文失败";            $this->array_return['AppendData']=null;        }else{            $this->array_return['ResultType']=self::__OK__;            $this->array_return['Message']="删除软文成功";            $this->array_return['AppendData']=$res;        }                return json($this->array_return);    }    public function GetArticleList()    {        if(!empty($this->_reqparam['keyword']))        {            $sql=" (title like '%".$this->_reqparam['keyword']."%' or content like '%".$this->_reqparam['keyword']."%')";            $where['_string']=empty($where['_string'])?$sql:$where['_string'].' and '.$sql;        }        $where['user_id']=$this->userInfo['id'];        $begin_position = (intval($this->_reqparam['current_page_number'])-1)*intval($this->_reqparam['page_size']);        $limit=$begin_position.",".$this->_reqparam['page_size'];        $articleList=$this->art_model->where($where)->limit($limit)->select();        foreach($articleList as $k => $v) {            if (mb_strlen($v['title']) > 10) {                $articleList[$k]['title'] = mb_substr($v['title'],0,10,'utf-8').'...';            }            $articleList[$k]['thumb']=ToOpenWxImage($articleList[$k]['thumb']);            $articleList[$k]['add_time']=date('Y-m-d H:i:s',$articleList[$k]['add_time']);        }        $res= $articleList;        if(!$res)        {            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="获取软文列表失败";            $this->array_return['AppendData']=null;        }else{            $this->array_return['ResultType']=self::__OK__;            $this->array_return['Message']="获取软文列表成功";            $this->array_return['AppendData']=$res;        }        return json($this->array_return);    }    public function GetArticleListAllUser()    {        if(!empty($this->_reqparam['tspopenid']))        {            $where['user_id']=$this->_reqparam['tspopenid'];        }        if(!empty($this->_reqparam['keyword']))        {            $sql=" (title like '%".$this->_reqparam['keyword']."%' or content like '%".$this->_reqparam['keyword']."%')";            $where['_string']=empty($where['_string'])?$sql:$where['_string'].' and '.$sql;        }        $begin_position = (intval($this->_reqparam['current_page_number'])-1)*intval($this->_reqparam['page_size']);        $limit=$begin_position.",".$this->_reqparam['page_size'];        $articleList=$this->art_model->where($where)->limit($limit)->select();        foreach($articleList as $k => $v) {            if (mb_strlen($v['title']) > 10) {                $articleList[$k]['title'] = mb_substr($v['title'],0,10,'utf-8').'...';            }            $articleList[$k]['thumb']=ToOpenWxImage($articleList[$k]['thumb']);            $articleList[$k]['add_time']=date('Y-m-d H:i:s',$articleList[$k]['add_time']);;        }        $res= $articleList;        if(!$res)        {            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="获取所有软文列表失败";            $this->array_return['AppendData']=null;        }else{            $this->array_return['ResultType']=self::__OK__;            $this->array_return['Message']="获取所有软文列表成功";            $this->array_return['AppendData']=$res;        }        return json($this->array_return);    }    public function GetTheArticle()    {        if(empty($this->_reqparam['id']))        {            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="要获取的软文没有填写！";            return json($this->array_return);        }        $where['user_id']=$this->userInfo['id'];        $where['id']=$this->_reqparam['id'];        $article=$this->art_model->where($where)->find();       if(!empty($article)) {            if (mb_strlen($article['title']) > 10) {                $article['title'] = mb_substr($article['title'],0,10,'utf-8').'...';            }           $article['thumb']=ToOpenWxImage($article['thumb']);        }        $res = $article;        if(empty($res))        {            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="获取软文失败";            $this->array_return['AppendData']=null;        }else{            $this->array_return['ResultType']=self::__OK__;            $this->array_return['Message']="获取软文成功";            $this->array_return['AppendData']=$res;        }        return json($this->array_return);    }    public function EditTheArticle()    {        if(empty($this->_reqparam['id']))        {            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="参数错误！";            return json($this->array_return);        }        if(empty($this->_reqparam['content']))        {            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="文章内容错误！";            return json($this->array_return);        }        if(empty($this->_reqparam['title']))        {            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="文章标题错误！";            return json($this->array_return);        }        $where['user_id']=$this->userInfo['id'];        $where['id']=$this->_reqparam['id'];        $data = array();        $data['content']=$this->_reqparam['content'];        $data['title']=$this->_reqparam['title'];        $data['add_time']=time();        $res = $this->art_model->where($where)->update($data);        if(empty($res))        {            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="软文编辑失败";            $this->array_return['AppendData']=null;        }else{            $this->array_return['ResultType']=self::__OK__;            $this->array_return['Message']="软文编辑成功";            $this->array_return['AppendData']=$res;        }        return json($this->array_return);    }    public function AddArticle()    {        if(empty($this->_reqparam['content']))        {            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="文章内容错误！";            return json($this->array_return);        }        if(empty($this->_reqparam['title']))        {            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="文章标题错误！";            return json($this->array_return);        }        $data=array();        $data['user_id']=$this->userInfo['id'];        $data['content']=$this->_reqparam['content'];        $data['title']=$this->_reqparam['title'];        $data['add_time']=time();        $res = $this->art_model->insert($data);        if(empty($res))        {            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="软文增加失败";            $this->array_return['AppendData']=null;        }else{            $this->array_return['ResultType']=self::__OK__;            $this->array_return['Message']="软文增加成功";            $this->array_return['AppendData']=$res;        }        return json($this->array_return);    }    public function Gps2Areas()    {        if(empty($this->_reqparam['la']))        {            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="请传入正确的纬度！";            return json($this->array_return);        }        if(empty($this->_reqparam['lo']))        {            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="请传入正确的经度！";            return json($this->array_return);        }                $ak='IVmvZZ1tGygIrhAOKGGvELITyE6WCsHC';        $result = \Geocoding::getAddressComponent($ak, $this->_reqparam['lo'], $this->_reqparam['la'], \Geocoding::NO_POIS);        $address=$result["result"]["addressComponent"];        if($address["province"]!=$address["city"])        {            $location=$address["province"].$address["city"].$address["district"].$address["street"];        }else{            $location=$address["city"].$address["district"].$address["street"];        }        if(!empty($location))        {            $ret["address"]=$location;        }        $areas= $this->user_logic->GetAreas($this->request);        if(!empty($address["province"]))        {            $ret["province_name"]=$address["province"];            foreach ($areas as $key=>$value)            {                if($areas[$key]['region_name']==$address["province"])                {                    $province=$areas[$key];                    $ret["province_id"]=$areas[$key]['region_id'];                    break;                }            }            if(!empty($address["city"]))            {                $ret["city_name"]=$address["city"];                if($address["province"]!=$address["city"]) {                    $citys = $province['ChildList'];                }else{                    $citys = array_merge($province['ChildList'][0]['ChildList'],$province['ChildList'][1]['ChildList']);                }                foreach ($citys as $key=>$value)                {                    if($address["province"]!=$address["city"]) {                        if ($citys[$key]['region_name'] == $address["city"]) {                            $city = $citys[$key];                            $ret["city_id"] = $citys[$key]['region_id'];                            break;                        }                    }else{                        $ret["city_id"]= $ret["province_id"];                        $city=array();                        $city['ChildList']=$citys;                        break;                    }                }                if(!empty($address["district"]))                {                    $ret["district_name"]=$address["district"];                    $districts=$city['ChildList'];                    foreach ($districts as $key=>$value)                    {                        if($districts[$key]['region_name']==$address["district"])                        {                            $district=$districts[$key];                            $ret["district_id"]=$districts[$key]['region_id'];                            break;                        }                    }                }            }        }        if(empty($ret))        {            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="地址不合法";            $this->array_return['AppendData']=null;        }else{            $this->array_return['ResultType']=self::__OK__;            $this->array_return['Message']="获取地址成功";            $this->array_return['AppendData']=$ret;        }        return json($this->array_return);    }}