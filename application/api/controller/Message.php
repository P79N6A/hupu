<?php/** * Created by PhpStorm. * User: admin * Date: 2017/12/7 * Time: 0:16 */namespace app\api\controller;use app\common\controller\ApiBase;use app\api\logic\Cards  as cardsLogic;use app\api\logic\User  as userLogic;class Message extends  ApiBase{	private $cards_logic = null;	    function initialize()    {    	parent::initialize();        $this->cards_logic = new cardsLogic();    }        public function MyFriends()    {    	$this->array_return['ResultType']=self::__ERROR__;        $this->array_return['Message']="获取网夹列表失败";        $this->array_return['AppendData']=null;        $where = $this->_reqparam;        $where['user_id'] = $this->userInfo['id'];        $list = $this->cards_logic->getCards($where);                if(!empty($list))        {            $this->array_return['ResultType']=self::__OK__;            $this->array_return['Message']="获取网夹列表成功";            $this->array_return['AppendData']=$list;        }                return json($this->array_return);    }    public function DeleteMyFriends()    {        $where = $this->_reqparam;        if(!isset($this->_reqparam['id']))        {            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="没有选择要删除的朋友！";            return json($this->array_return);        }else{            $where['id']=$this->_reqparam['id'];        }                    $this->array_return['ResultType']=self::__ERROR__;        $this->array_return['Message']="删除朋友失败";        $this->array_return['AppendData']=null;        //TODO:删除朋友时没有加userid条件，删除朋友条件中除了要有ID，还应该有user_id        $result =$this->cards_logic->delCards($where);        if(!empty($result))        {            $this->array_return['ResultType']=self::__OK__;            $this->array_return['Message']="删除朋友成功";            $this->array_return['AppendData']=$result;        }                return json($this->array_return);    }    public function ViewMyFriend()    {        $where = $this->_reqparam;        if(!isset($this->_reqparam['id']))        {            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="没有选择要查看的朋友！";            return json($this->array_return);        }else{            $where['id']=$this->_reqparam['id'];        }        //TODO:删除朋友时没有加userid条件，查看朋友条件中除了要有ID，还应该有user_id        $this->array_return['ResultType'] = self::__ERROR__;        $this->array_return['Message'] = "获取朋友资料失败";        $this->array_return['AppendData'] = null;        $result = $this->cards_logic->getCardsInfo($where);        if(!empty($result))        {            $this->array_return['ResultType'] = self::__OK__;            $this->array_return['Message']="查看朋友成功";            $this->array_return['AppendData']=$result;        }                return json($this->array_return);    }    public function AddTrading()    {        $data = array();        $data['user_id']=$this->userInfo['id'];        if(!isset($this->_reqparam['tradId']))        {            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="没有选择要交换V网的朋友！";            return json($this->array_return);        }else{        	$user_logic = new userLogic();            $object_user = $user_logic->getUserInfoOption(array('spopenid'=>$this->_reqparam['spopenid']));            if(empty($object_user))            {                $this->array_return['ResultType']=self::__ERROR__;                $this->array_return['Message']="要交换V网的朋友的资料没有找到！";                return json($this->array_return);            }            $data['object_id']=$object_user['id'];        }        if(!isset($this->_reqparam['notice']))        {            $this->array_return['ResultType']=self::__ERROR__;            $this->array_return['Message']="交朋友总得说点什么吧！";            return json($this->array_return);        }else{            $data['msg']=$this->_reqparam['notice'];        }                    $this->array_return['Message']= '请勿重复申请';        $this->array_return['ResultType']=self::__ERROR___;        $result = $this->cards_logic->applyCards($data);        if($result){            $this->array_return['Message']="交换微网申请成功";            $visit_id=$this->_reqparam['visit_id'];            if($visit_id){//通过分享                $result=$this->cards_logic->addCollection($this->userInfo['id'],$this->_reqparam['tradId'],$visit_id);                if($result)                {                    $this->array_return['Message'].='加入收藏成功！';                    $this->array_return['ResultType']=self::__OK__;                }else{                    $this->array_return['Message'].='加入收藏失败！';                    $this->array_return['ResultType']=self::__OK__;                }            }else{//通过加好友                $this->array_return['Message'].='交换微网申请成功!！';                $this->array_return['ResultType']=self::__OK__;            }        }                return json($this->array_return);    }}