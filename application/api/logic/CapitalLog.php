<?php/***********资金记录表逻辑层************ */namespace app\api\logic;use think\Model;use app\api\model\UserInfo  as userModel;use app\api\model\VipGroup  as groupModel;use app\api\model\CapitalLog  as capitalModel;use app\api\model\Member  as memberModel;class CapitalLog extends Model{    private $User = null;    private $CapitalLog = null;    private $VipGroup = null;	private $Member = null;    private $pageNum = 20;    function __construct()    {        $this->User = new userModel();        $this->VipGroup = new groupModel();        $this->CapitalLog = new capitalModel();        $this->Member = new memberModel();    }    public function getLogData($options=array())    {    	//获取我的钱包数据        $user_id=$options['user_id'];        $user=$this->User->where(array('id'=>$user_id))->find();        $data['balance']=$user['money'];//余额        $data['money']=number_format($user['money']+$user['frozen_money']+$user['already_money'],2,".","");//总收入        $data['recommend']=$this->getMoney($user_id,1);//推荐收入，直接粉丝收入        $data['article']=$this->getMoney($user_id,2);//文章打赏收入        $data['share']=$this->getMoney($user_id,11);//文章打赏收入        $data['give_vip1']=$this->getMoney($user_id,3);//赠送vip收入        $data['give_vip2']=$this->getMoney($user_id,4);//赠送小创投收入        $data['give_vip3']=$this->getMoney($user_id,5);//会员续费（年费奖励）        $data['give_vip4']=$this->getMoney($user_id,6);//间接收入        $data['give_vip5']=$this->getMoney($user_id,7);//管理分佣（招商奖励）        $data['reward']=$this->CapitalLog->where(array('user_id'=>$user_id,'reward'=>array('neq',0),'as'=>1))->column('sum(money)');//提成收入        $data['reward']=empty($data['reward'])?number_format(0,2,".",""):$data['reward'];        $group=$this->VipGroup->where(array('id'=>$user['vip_group_id']))->find();        $data['level']=$group['level'];        $data['give_count']=$group['give_vip1_count'];//赠送V网总数        if($group['level']==1){            $data['give_count']=0;//赠送V网总数            $data['give_vip1_count']=$group['give_vip1_count']-$user['give_vip1_count'];//赠送VIP会员总数            $data['vip1_count']=$user['give_vip1_count'];//赠送VIP会员剩余//            $data['give_count']=$data['give_vip1_count'];//赠送V网总数        }elseif($group['level']==2){//小创投可赠送数量//            $data['give_count']=0;//赠送V网总数            $data['cangive_vip1_count']=$group['give_vip1_count'];            $data['give_vip1_count']=$group['give_vip1_count']-$user['give_vip1_count'];//赠送VIP会员总数            $data['vip1_count']=$user['give_vip1_count'];//赠送VIP会员剩余//            $data['give_count']=$data['give_vip1_count'];//赠送V网总数        }elseif($group['level']==3){            $data['cangive_vip1_count']=$group['give_vip1_count'];            $data['give_vip1_count']=$group['give_vip1_count']-$user['give_vip1_count'];//赠送VIP会员总数            $data['vip1_count']=$user['give_vip1_count'];//赠送VIP会员剩余          //  $data['give_vip2_count']=$group['give_vip2_count']-$user['give_vip2_count'];//赠送小创投总数          //  $data['vip2_count']=$user['give_vip2_count'];//赠送小创投剩余        }elseif($group['level']==4){//            $data['give_count']=0;//赠送V网总数            $data['cangive_vip1_count']=$group['give_vip1_count'];            $data['give_vip1_count']=$group['give_vip1_count']-$user['give_vip1_count'];//赠送VIP会员总数            $data['vip1_count']=$user['give_vip1_count'];//赠送VIP会员剩余           // $data['give_vip2_count']=$group['give_vip2_count']-$user['give_vip2_count'];//赠送小创投总数           // $data['vip2_count']=$user['give_vip2_count'];//赠送小创投剩余            $data['cangive_vip3_count']=$group['give_vip3_count'];            $data['give_vip3_count']=$group['give_vip3_count']-$user['give_vip3_count'];//赠送创投总数            $data['vip3_count']=$user['give_vip3_count'];//赠送创投剩余//            $data['give_count']=$data['give_vip1_count']+$data['give_vip3_count'];//赠送V网总数 +$data['give_vip2_count']        }elseif($group['level']>=5){            $data['cangive_vip1_count']=$group['give_vip1_count'];            $data['give_vip1_count']=$group['give_vip1_count']-$user['give_vip1_count'];//赠送VIP会员总数            $data['vip1_count']=$user['give_vip1_count'];//赠送VIP会员剩余            //$data['give_vip2_count']=$group['give_vip2_count']-$user['give_vip2_count'];//赠送小创投总数            //$data['vip2_count']=$user['give_vip2_count'];//赠送小创投剩余            $data['cangive_vip3_count']=$group['give_vip3_count'];            $data['give_vip3_count']=$group['give_vip3_count']-$user['give_vip3_count'];//赠送创投总数            $data['vip3_count']=$user['give_vip3_count'];//赠送创投剩余            $data['cangive_vip4_count']=$group['give_vip4_count'];            $data['give_vip4_count']=$group['give_vip4_count']-$user['give_vip4_count'];//赠送创业家总数            $data['vip4_count']=$user['give_vip4_count'];//赠送创业家剩余//            $data['give_count']=$data['give_vip1_count']+$data['give_vip3_count']+$data['give_vip4_count'];//赠送V网总数$data['give_vip2_count']+        }        return $data;    }    public function getHistoryLog($options=array())    {	    //获取各种历史流水账单        $start_time=0;//开始时间        $end_time=0;//结束时间        $where=array();        $type=$options['type'];        if(empty($options['start_time'])){            switch ($type)            {                case 1:                    $plan_time=time();                    $start_time=$plan_time-((date('w')==0?7:date('w'))-1)*24*3600;                    $end_time=$plan_time+(7-(date('w')==0?7:date('w')))*24*3600;                break;                case 2:                    $timestamp=time();                    $firstday=date('Y-m-01',strtotime(date('Y',$timestamp).'-'.(date('m',$timestamp)-1).'-01'));                    $lastday=date('Y-m-d',strtotime("$firstday +1 month -1 day"));                    $start_time=strtotime($firstday);                    $end_time=strtotime($lastday);                     break;                case 3:                    $timestamp=time();                    $firstday=date('Y-m-01',strtotime(date('Y',$timestamp).'-'.'01-01'));                    $lastday= date('Y-m-d', strtotime(date('Y-m', $timestamp) . '-01 00:00:00') - 86400);                    $start_time=strtotime($firstday);                    $end_time=strtotime($lastday);                    break;                default:;            }        }        if($type!=0){            $where['_string']="c.add_time>=".$start_time." and c.add_time<=".$end_time;        }        switch ($options['get_type'])        {            case 1:                $where['c.type']=1;                break;            case 2:                //文章打赏                $where['c.type']=2;                break;            case 3:                //赠送vip收入                $where['c.type']=1;                $where['c.is_give']=1;                $where['c.vip_group']=1;                break;            case 4:                //赠送小创投收入                $where['c.type']=1;                $where['c.is_give']=1;                $where['c.vip_group']=2;                break;            case 5:                //赠送创投收入                $where['c.type']=1;                $where['c.is_give']=1;                $where['c.vip_group']=3;                break;            case 6:                //赠送创业家收入                $where['c.type']=1;                $where['c.is_give']=1;                $where['c.vip_group']=4;                break;            case 7:                //赠送创导收入                $where['c.type']=1;                $where['c.is_give']=1;                $where['c.vip_group']=5;                break;            case 8:                //商会收入（间接粉丝收入）                $where['c.type']=6;                break;            case 9:                //招商奖励                $where['c.type']=7;                break;            case 10:                //年费奖励                $where['c.type']=8;                break;            case 11:                //共享推广奖励                $where['c.type']=99;                break;            default:                $where['c.type']=array('in',array(1,6,7,8));        }        $where['c.user_id']=$options['user_id'];        if($options['get_type'] ==2){            $field="c.id,c.user_id,c.object_id,c.msg,c.money,c.add_time,c.order_sn,a.nick_name";            $data = Db::table('s_capital_log')->alias('c')                ->leftJoin(' s_article_rewardlog as a','a.id = c.object_id')                ->field($field)                ->where($where)                ->order('c.id desc')                ->select();        }else{            $field="c.id,c.user_id,c.object_id,c.msg,c.money,c.add_time,c.order_sn,u.nick_name";            $data = Db::table('s_capital_log')->alias('c')                ->leftJoin(' s_user_detail as u','u.id = c.object_id')                ->field($field)                ->where($where)                ->order('c.id desc')                ->select();            foreach ($data as &$v){                if(!$v['add_time']  && $v['order_sn']){                    if(substr($v['order_sn'],0,8) != '21474836'){                        $v['add_time'] = Db::table('s_vip_order')->where(array('order_no'=>$v['order_sn']))->column('add_time');                    }                }            }        }                return $data;    }    public function getHistoryLogInfo($options=array())    {        //获取各种历史流水详情        $where['c.user_id']=$options['user_id'];        $where['c.id']=$options['id'];//        $data=$this->CapitalLog->where($where)->find();        $data = Db::table('s_capital_log')->alias('c')            ->leftJoin(' s_user_detail u','u.id = c.object_id')            ->leftJoin(' s_user_detail ru','ru.id = u.rec_user_id')            ->leftJoin(' s_member m','m.id = u.member_id')            ->leftJoin(' s_vip_group v','v.id = u.vip_group_id')            ->field('c.add_time,c.as,u.nick_name as username,ru.nick_name as rec_user,m.phone,u.rec_user_id,v.vip_name,c.money,u.id,c.order_sn')            ->where($where)            ->find();//        $user=$this->User->where(array('id'=>$data['object_id']))->find();//        $data['username']=$user['nick_name'];        $data['consume']="微信";//消费方式//        $data['rec_user']=$this->User->where(array('id'=>$user['rec_user_id']))->column("nick_name");//        $data['phone']=$this->Member->where(array('id'=>$user['member_id']))->column("phone");//账号        if($data['rec_user_id'] != $options['user_id']){            $data['phone'] = substr($data['phone'],0,3).'****'.substr($data['phone'],7);        }//        $data['vip_name']=$this->VipGroup->where(array('id'=>$data['vip_group']))->column("vip_name");        $data['consumption']=$this->CapitalLog->where(array('order_sn'=>$data['order_sn'],'user_id'=>$data['id']))->column("money");        if(!$data['add_time']  && $data['order_sn']){            if(substr($data['order_sn'],0,8) != '21474836'){                $data['add_time'] = Db::table('s_vip_order')->where(array('order_no'=>$data['order_sn']))->column('add_time');            }        }                return $data;    }    public function getConsume($options=array())    {        //获取共享活动列表        $where = array();        if(!empty($options['page'])){            if(empty($options['pageNum'])){                $options['pageNum']=$this->pageNum;            }            $options['limit']=($options['page']-1)*$options['pageNum'].",".$options['pageNum'];        }        $where['user_id'] = $options['user_id'];        $list = Db::table('s_user_consume')            ->where($where)            ->order('id DESC')            ->limit($options['limit'])            ->select();        if ($list){            return $list;        }else{            return false;        }    }    public function getMoney($user_id,$type)    {        //获取用户金额        $where['user_id']=$user_id;        $where['as']=1;        switch ($type){            case 1:                //推荐有奖                $where['type']=1;                break;            case 2:                //文章打赏收入                $where['type']=2;                break;            case 3:                //赠送vip收入                $where['type']=1;                $where['is_give']=1;                $where['vip_group']=1;                break;            case 4:                //赠送小创投收入                $where['type']=1;                $where['is_give']=1;                $where['vip_group']=2;                break;            case 5:                //会员续费(年费奖励)                $where['type']=8;                break;            case 6:                //间接粉丝收入                $where['type']=6;                break;            case 7:                //管理分佣（招商奖励）                $where['type']=7;                break;            case 11:                //管理分佣（招商奖励）                $where['type']=99;                break;            default:;        }                $money=$this->CapitalLog->where($where)->column('sum(money)');        return empty($money)?number_format("0",2,".",""):$money;    }}