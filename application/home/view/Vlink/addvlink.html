<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="__HOME_CSS__/wh/base.css">
    <script src="__HOME_JS__/whjs/js/jquery-1.8.3.min.js"></script>
    <script src="__HOME_JS__/whjs/js/newrem.js"></script>

    <script src="__HOME_JS__/whjs/js/hammer.min.js"></script>
    <script src="__HOME_JS__/whjs/js/lrz.all.bundle.js"></script>
    <script src="__HOME_JS__/whjs/js/iscroll-zoom-min.js"></script>
    <script src="__HOME_JS__/whjs/js/PhotoClip.js"></script>
    <title>添加链接</title>
    <style>
        body,html{
            background: #fff;
        }
        *{
            padding:0;
            margin:0;
            /* border: 1px solid red; */
        }
        .content{
            margin:.2rem auto;
            padding:0 .16rem;
            box-sizing: border-box;
        }
        .toptit {
            height: .22rem;
            font-size: .16rem;
            font-family: PingFangSC-Semibold;
            font-weight: 600;
            color: #333;
            line-height: .22rem;
        }
        .first{
            width:100%;
            height:.55rem;
            position: relative;
            border-bottom:1px solid #F6F6F6;
        }
        .titbt{
            width:90%;
            height:.2rem;
            line-height:.2rem;
            border:none;
            outline: none;
            position: absolute;
            font-size:.14rem;
            bottom:.1rem;
            color:#C5C5C5;
            font-family:PingFangSC-Regular;
            font-weight:400;
        }
        .secd{
            width:100%;
            height:.63rem;
            font-size:.16rem;
            font-family:PingFangSC-Semibold;
            font-weight:600;
            line-height: .63rem;
            border-bottom:1px solid #F6F6F6;
            position: relative;
        }
        .sedright{
            width:.41rem;
            height:.42rem;
            top:.11rem;
            right:0;
            position:absolute;
            border-radius: .06rem;
            overflow: hidden;
          
        }
        .sedright img{
            width:.41rem;
            height:.42rem;
            position: absolute;
            background-size: 100% 100%;
        }
        .three{
            width:100%;
            height:.65rem;
            position: relative;
            border-bottom:1px solid #f6f6f6;
        }
        .chosebq{
            height:.22rem;
            font-size:.16rem;
            font-family:PingFangSC-Semibold;
            font-weight:600;
            color:#333;
            line-height:.22rem;
            position: absolute;
            top:.12rem;
        }
        .chose{
            /* width:.4rem; */
            height:.17rem;
            font-size:.12rem;
            font-family:PingFangSC-Regular;
            font-weight:400;
            color:#C5C5C5;
            line-height:.17rem;
            position: absolute;
            bottom:.12rem;
        }
        ul{
            list-style: none;
            width:5rem;
        }

        .yid li{
            white-space: nowrap;
        }
    .firstr{
        width:.24rem;
        height:.17rem;
        font-size:.12rem;
        font-family:Roboto-Regular;
        font-weight:400;
        color:rgba(239,123,107,1);
        display: inline-block;
        border: 1px solid #FFCEC7;
        padding: .02rem .12rem;
    }
    .secr{
        width:.24rem;
        height:.17rem;
        font-size:.12rem;
        font-family:Roboto-Regular;
        font-weight:400;
        color:#57A9F9;
        display: inline-block;
        border: 1px solid #C3E1FF;
        padding: .02rem .12rem;
    }
    
    .hotr{
        width:.24rem;
        height:.17rem;
        font-size:.12rem;
        font-family:Roboto-Regular;
        font-weight:400;
        color:#E4BD27;
         display: inline-block;
        border: 1px solid #FFEB9D;
        padding: .02rem .12rem;
    }
    
    .hesdr{
        width:.24rem;
        height:.17rem;
        font-size:.12rem;
        font-family:Roboto-Regular;
        font-weight:400;
        color:#8085FF;
        display: inline-block;
        border: 1px solid #D6D8FF;
        padding: .02rem .12rem;
    }
    
    .secrj{
        width:.24rem;
        height:.17rem;
        font-size:.12rem;
        font-family:Roboto-Regular;
        font-weight:400;
        color:#9FE97F;
         display: inline-block;
        border: 1px solid #CCF4BA;
        padding: .02rem .12rem;
    }
    
    .secrl{
        width:.24rem;
        height:.17rem;
        font-size:.12rem;
        font-family:Roboto-Regular;
        font-weight:400;
        color:#997BEC;
         display: inline-block;
        border: 1px solid #D3C3FF;
        padding: .02rem .12rem;
    
    }
    .secjl{
        width:.24rem;
        height:.17rem;
        font-size:.12rem;
        font-family:Roboto-Regular;
        font-weight:400;
        color:#2AD4D8;
         display: inline-block;
        border: 1px solid #99EBED;
        padding: .02rem .12rem;
    
    }
    .secrr{
        width:.24rem;
        height:.17rem;
        font-size:.12rem;
        font-family:Roboto-Regular;
        font-weight:400;
        color:#F0A73D;
        display: inline-block;
        border: 1px solid #FFD496;
        padding: .02rem .12rem;
    
    }
    .yinc{
        width: 2.3rem;
        position: absolute;
        left: 1.12rem;
        top: .22rem;
        height: .27rem;
        overflow: hidden;
        height: 1rem;
     
    }

    .yinc .yid{
        width: 100%;
        height: 100%;
        overflow-x: scroll;
        overflow-y: hidden;
        white-space: nowrap;
    }
    .four{
        width:100%;
        height:.86rem;
        position: relative;
        border-bottom: 1px solid #F6F6F6;
    }
    .tzlj{
        height:.22rem;
        font-size:.16rem;
        font-family:PingFangSC-Semibold;
        font-weight:600;
        color:#333;
        line-height:.22rem;
        position: absolute;
        top: .12rem;
    }
    .tzljtit{
        width:3.37rem;
        height:.2rem;
        font-size:.14rem;
        font-family:PingFangSC-Regular;
        font-weight:400;
        color:#9B9B9B;
        line-height:.2rem;
        outline: none;
        position:absolute;
        bottom:.24rem;
        border:none;
    }
    #sure{
        width: 3.43rem;
        height: .4rem;
        background: #32CEA0;
        margin: 0 auto;
        left: 10%;
        color: #fff;
        font-size: .14rem;
        text-align: center;
        position: absolute;
        border: none;
        outline: none;
        bottom: .1rem;
        left:.16rem;
        cursor: pointer;
        -webkit-appearance: none;
        border-radius: .04rem;
    }
    #fileup{
        width:100%;
        height:100%;
        position: absolute;
        z-index: 9;
        top:0;
        left: 0;
        opacity: 0;
    }
    .acren{
        width:24px;
        height:17px;
        font-size:12px;
        font-family:Roboto-Regular;
        font-weight:400;
        line-height:14px;
        display: inline-block;
        border: 1px solid #FFCEC7;
        padding: 2px 12px;
        background:#FFCEC7;
    }

    .img_box{
        width: 100%;
        height: 100%;
        position: relative;
    }

    .tips{
        width: 2rem;
        padding: .05rem .1rem;
        background: rgba(0, 0, 0, 0.5);
        color: #fff;
        text-align: center;
        position: fixed;
        top: 50%;
        left: 50%;
        margin-left: -1.05rem;
        border-radius: .04rem;
        display: none;
        
    }


       @-webkit-keyframes change {
            0% {
            -webkit-transform: rotate(0deg);
            }
            50% {
            -webkit-transform: rotate(180deg);
            }
            100% {
            -webkit-transform: rotate(360deg);
            }
            }

            .loading{
            width: 155px;
            height: 120px;
            position: fixed;
            top: 50%;
            left: 50%;
            margin-left: -77.5px;
            margin-top: -60px;
            text-align: center;
            display: none;
            background-color: rgba(0, 0, 0,0.5);
            border-radius: 5px;
            z-index: 1001;

            }

            .loading img{
            width: 40px;
            height: 40px;
            margin-top: 18px;
            animation: change 3s linear infinite;
            }

            .loading span{
            display: block;
            color: #fff;
            margin-top: 12px;
            font-size: 16px;
            }


                /* 截图的 */

            	.btun {
				width: 274px;
				height: 10%;
				margin: 0 auto;
			}
			
			#clipBtn {
				width: 35%;
				height: 40px;
				line-height: 40px;
				background-color: #32CEA0;
				color: #fff;
				text-align: center;
				border: none;
				position: relative;
				z-index: 999;
                border-radius: 5px;
			}
			
			#cancel {
				background-color: #fff;
				color: #000;
				width: 35%;
				height: 40px;
				line-height: 40px;
				border-radius: 5px;
				border: none;
				margin-right: 26%;
				position: relative;
				z-index: 999;
			}
			
			.gif {
				position: fixed;
				top: 0;
				left: 0;
				z-index: 229;
				width: 100%;
				height: 100%;
				text-align: center;
				display: none;
			}
			
			.gif>img {
				position: absolute;
				top: 32%;
				left: 34%;
			}

            #clipArea {
				height: 85%;
                width: 100%;
			}

            .clip {
				background-color: #000;
				display: none;
				width: 100%;
				height: 100%;
				position: fixed;
				top: 0;
				z-index: 10000;
			}
			
			.photo-clip-view {
				background-color: #fff;
			}
            *{ -webkit-tap-highlight-color: rgba(0,0,0,0);-webkit-tap-highlight-color: transparent; /* For some Androids */ }

    </style>

<body>
    <div class="content">
        <div class="first">
            <div class="toptit">链接标题</div>
            <input type="text" class="titbt" placeholder="输入您的链接标题">
        </div>
        <div class="secd">
            <div class="sedleft">封面</div>
            <div class="sedright">
                <div class="img_box">
                    <img src="__HOME_IMAGES__/vwzz/image_fengmian.png" class="fonli" id="fengm" alt="">
                    <input type="file" id="fileup" accept="image/*">
                </div>
            </div>
        </div>
        <div class="three">
            <span class="chosebq">选择标签</span>
            <span class="chose">可选3个标签</span>
            <div class="yinc">
                <ul class="yid">
                    <li class="firstr" data-color="#EF7B6B">美文</li>
                    <li class="secr" data-color="#57A9F9">资讯</li>
                    <li class="hotr" data-color="#E4BD27">热点</li>
                    <li class="hesdr" data-color="#8085FF">头条</li>
                    <li class="secrj" data-color="#9FE97F">娱乐</li>
                    <li class="secrl" data-color="#997BEC">要闻</li>
                    <li class="secjl" data-color="#2AD4D8">时尚</li>
                    <li class="secrr" data-color="#F0A73D">独家</li>
                </ul>

            </div>
        </div>
        <div class="four">
            <div class="tzlj">跳转链接</div>
            <input type="text" class="tzljtit" placeholder="请输入网址并在前面加上http://" value="">
        </div>
    </div>

    <button id="sure" onclick="sure()">确定</button>
    <div class="tips"></div>
    <div class="mask"></div>
    <div class="loading">
        <img src="__HOME_IMAGES__/loadad.gif" alt="">
        <span>正在上传中</span>
    </div>
    <!-- //截图的 -->
    <div class="clip">
        <div class="gif">
            <img src="__HOME_IMAGES__/new_load.gif" alt="" />
        </div>
        <div id="clipArea"></div>
        <div class="btun">
            <button id="cancel">取消</button>
            <button id="clipBtn">截取</button>
        </div>
    </div>
</body>
<script>
    function GetQueryString(name) {
        if (window.location.href.indexOf('?') > -1) {
            var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
            var r = decodeURIComponent(window.location.href.substr(1).split('?')[1]).match(reg);
            if (r != null) return unescape(r[2]);
        }
        return ''; //便于容错处理
    }

    var fl_id = GetQueryString('typeid');
    var edit_id = GetQueryString('edit_id');
    var tit = GetQueryString('title');
    console.log(edit_id)
    console.log(fl_id)

    //选择颜色
    var color_arr = ['#FFCEC7', '#C3E1FF', '#FFEB9D', '#D6D8FF', '#CCF4BA', '#D3C3FF', '#99EBED', '#FFD496'];
    var choiseobj = [];
    $('.yid').on('click', 'li', function () {
        var index = $(this).index();

        var text = $(this).text();
        // var color = $(this).css('color');
        var color = $(this).attr('data-color');

        $(this).toggleClass('switch');
        if ($(this).hasClass('switch')) {
            if (choiseobj.length >= 3) {
                var tips = $('.tips');
                tips.text('只能选择3个标签哦').stop(true).fadeIn(500).fadeOut(2000);
                return false;
            }
            $(this).css('background', color_arr[index]);
            $(this).attr('data-bg', color_arr[index]);
            var bgcolor = $(this).attr('data-bg');
            var obj = {};
            obj.name = text;
            obj.color = color;
            obj.background = bgcolor;
            choiseobj.push(obj);


        } else {
            $(this).css('background', '#fff');
            choiseobj.remove(text)
        }

        console.log(choiseobj)
    })

    Array.prototype.remove = function (val) {
        var index;
        $.each(choiseobj, function (k, v) {
            if (val == v.name) {
                console.log(k)
                index = k;
            }
        })
        if (index > -1) {
            this.splice(index, 1);
        }
    };


    var unionid = '{$unionid}';
    var imgsrc;
    var downing;

    function sure() {

        var tips = $('.tips');

        if ($(".titbt").val() == '') {
            tips.text('请填写链接标题').stop(true).fadeIn(500).fadeOut(2000);
            return false;
        }

        if ($("#fengm").attr('src') == '__HOME_IMAGES__/vwzz/image_fengmian.png') {
            tips.text('请上传封面图片').stop(true).fadeIn(500).fadeOut(2000);
            return false;
        }
        if ($(".tzljtit").val() == "http://") {
            tips.text('请添加链接地址').stop(true).fadeIn(500).fadeOut(2000);
            return false;
        }
        if (choiseobj.length == 0) {
            tips.text('请选择一个标签').stop(true).fadeIn(500).fadeOut(2000);
            return false;
        }

        var title = $('.titbt').val();
        var cover_img = $("#fengm").attr('src');
        var title_content = $(".tzljtit").val();

        console.log(title)
        console.log(cover_img)
        console.log(title_content)
        console.log(choiseobj)

        $.ajax({
            url: "index.php?s=/Api/AppApi/edit_nav",
            type: "post",
            data: {
                unionid: unionid,
                title: title,
                cover_img: cover_img,
                jump_url: title_content,
                tab: choiseobj,
                type_id: fl_id,
                nav_id: edit_id,

            },
            success: function (res) {
                console.log(res)
                tips.text('保存成功').stop(true).fadeIn(500).fadeOut(2000);
                setTimeout(function () {
                    window.location.href = '/index.php?s=/Home/vlink/linkdisplay.html&typeid=' +
                        fl_id + '&title=' + tit + ''; //跳转到的B页面的链接
                }, 1000)

            }
        })
    }

    var clipArea = new PhotoClip("#clipArea", {
        size: [336, 224],
        outputSize: [640, 640],
        file: "#fileup",
        ok: "#clipBtn",
        loadStart: function () {
            $('.gif').show();
        },
        loadComplete: function () {
            $('.gif').hide();
        },
        done: function (dataURL) {
            var imgsrc = dataURL;
            $.ajax({
                url: "/index.php?s=/Api/IndexApi/uploads_img",
                type: "post",
                data: {
                    unionid: unionid,
                    img: imgsrc,
                    start_name: "link",
                },
                beforeSend: function () {
                    $('.loading').show()
                    $('.mask').show()
                },
                success: function (res) {
                    console.log(res)
                    downing = res.AppendData;
                    $(".sedright .fonli").attr("src", downing);
                    $('.loading').hide()
                    $('.mask').hide()

                },
                error: function () {
                    console.log('走了错误')
                    $('.loading').hide()
                    $('.mask').hide()
                }
            })

        }
    });

    $('#fileup').on('click', function () {
        $('.clip').show();
    })

    $('#clipBtn,#cancel').on('click', function () { //截取 取消
        $('.clip').hide();

    })







    // 修改
    if (!fl_id == '' && !edit_id == '') {

        $.ajax({
            type: 'post',
            url: '/index.php?s=/Api/AppApi/link_list',
            data: {
                unionid: unionid,
                type_id: fl_id
            },
            success: function (res) {
                console.log(res)
                if (res.ResultType == 0) {
                    var data = res.AppendData;
                    var edit_data;
                    $.each(data, function (k, v) {
                        if (v.id == edit_id) {
                            edit_data = v;
                        }
                    })

                    console.log(edit_data)
                    $('.first').find('.titbt').val(edit_data.name) //链接标题
                    $('.img_box').find('.fonli').attr('src', edit_data.icon_url) //封面图、
                    $('.four').find('.tzljtit').val(edit_data.jump_url) //

                    $('.yid li').each(function (i, e) {
                        if ($(e).text() == edit_data.tab[0].name) {
                            $(this).attr('data-bg', edit_data.tab[0].color);
                            $(this).css('background', edit_data.tab[0].background).addClass(
                                'switch');
                        }
                        if ($(e).text() == edit_data.tab[1].name) {
                            $(this).attr('data-bg', edit_data.tab[1].color);
                            $(this).css('background', edit_data.tab[1].background).addClass(
                                'switch');
                        }
                        if ($(e).text() == edit_data.tab[2].name) {
                            $(this).attr('data-bg', edit_data.tab[2].color);
                            $(this).css('background', edit_data.tab[2].background).addClass(
                                'switch');
                        }

                    })

                    for (var i = 0; i < edit_data.tab.length; i++) {
                        choiseobj.push(edit_data.tab[i]);
                    }

                    console.log(choiseobj)


                }
            }
        })
    }
</script>
<script src="https://res.wx.qq.com/open/js/jweixin-1.0.0.js" type="text/javascript"></script>
<script type="text/javascript">
	document.addEventListener('WeixinJSBridgeReady', function onBridgeReady() {
		// 通过下面这个API隐藏右上角按钮hideOptionMenu
		WeixinJSBridge.call('hideOptionMenu');
	});
</script>

</html>